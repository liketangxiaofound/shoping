# .gitlab-ci.yml
stages:
  - validate
  - build
  - test
  - deploy

# é˜¶æ®µ1: ä»£ç éªŒè¯
validate-code:
  stage: validate
  script:
    - echo "ğŸ” å¼€å§‹ä»£ç è¯­æ³•æ£€æŸ¥..."
    - echo "================================="
    - |
      # æ£€æŸ¥åç«¯ç›®å½•æ˜¯å¦å­˜åœ¨
      if (Test-Path "back") {
        Write-Host "æ£€æŸ¥åç«¯ä»£ç  (back/)..."
        cd back
        $jsFiles = Get-ChildItem -Recurse -Filter *.js
        Write-Host "æ‰¾åˆ°JavaScriptæ–‡ä»¶: $($jsFiles.Count)"
        
        # æ£€æŸ¥è¯­æ³•é”™è¯¯
        Write-Host "æ£€æŸ¥è¯­æ³•é”™è¯¯..."
        $errorCount = 0
        foreach ($file in $jsFiles) {
          if (node -c $file.FullName 2>$null) {
            Write-Host "  âœ… $($file.Name) - è¯­æ³•æ­£ç¡®"
          } else {
            Write-Host "  âŒ $($file.Name) - è¯­æ³•é”™è¯¯"
            $errorCount++
          }
        }
        
        if ($errorCount -eq 0) {
          Write-Host "âœ… åç«¯ä»£ç è¯­æ³•æ£€æŸ¥é€šè¿‡"
        } else {
          Write-Host "âš ï¸  å‘ç° $errorCount ä¸ªè¯­æ³•é”™è¯¯"
        }
        cd ..
      } else {
        Write-Host "âš ï¸  åç«¯ç›®å½•ä¸å­˜åœ¨"
      }
    - echo "================================="
  tags:
    - local
  only:
    - main
  allow_failure: false

# é˜¶æ®µ2: æ„å»º
build-job:
  stage: build
  script:
    - echo "ç¼–è¯‘ä»£ç ..."
    - echo "ç¼–è¯‘å®Œæˆã€‚"
    - |
     if (Test-Path "back") {
        Write-Host "å®‰è£…åç«¯ä¾èµ–..."
        cd back
        npm install
        cd ..
        Write-Host "âœ… åç«¯ä¾èµ–å®‰è£…å®Œæˆ"
      }
     # 2. æ„å»ºå‰ç«¯ï¼ˆå¦‚æœæœ‰ï¼‰
    - |
      if (Test-Path "front") {
        Write-Host "æ„å»ºå‰ç«¯..."
        cd front
        npm install
        npm run build
        cd ..
        Write-Host "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
      }
  tags:
    - local
  only:
    - main

# é˜¶æ®µ3: æµ‹è¯•
unit-test-job:
  stage: test
  script:
    - echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
    - echo "æµ‹è¯•å®Œæˆã€‚"
  tags:
    - local
  only:
    - main
  allow_failure: true

# é˜¶æ®µ4: åŠè‡ªåŠ¨éƒ¨ç½²ï¼ˆéœ€è¦SSHé…ç½®ï¼‰
deploy-semi-auto:
  stage: deploy
  before_script:
    - |
      Write-Host "ğŸ› ï¸ é…ç½® SSH ç¯å¢ƒ..." -ForegroundColor Cyan
      
      $sshDir = "$env:USERPROFILE\.ssh"
      if (-not (Test-Path $sshDir)) {
        New-Item -ItemType Directory -Path $sshDir | Out-Null
      }
      
      # è®¾ç½® .ssh ç›®å½•æƒé™ï¼ˆä»…å½“å‰ç”¨æˆ·ï¼‰
      icacls $sshDir /inheritance:r /grant:r "$env:USERNAME:(F)" | Out-Null
      
      # æ£€æŸ¥ SSH_PRIVATE_KEY
      if ($env:SSH_PRIVATE_KEY) {
        Write-Host "âœ… æ‰¾åˆ° SSH_PRIVATE_KEY å˜é‡"
        $keyFile = "$sshDir\id_rsa"
        Set-Content -Path $keyFile -Value $env:SSH_PRIVATE_KEY -NoNewline
        
        # è®¾ç½®ç§é’¥æƒé™ï¼ˆä»…å½“å‰ç”¨æˆ·è¯»å†™ï¼‰
        icacls $keyFile /inheritance:r /grant:r "$env:USERNAME:(R,W)" | Out-Null
        Write-Host "âœ… SSH ç§é’¥å·²é…ç½®"
      } else {
        Write-Host "âš ï¸ æœªè®¾ç½® SSH_PRIVATE_KEY å˜é‡" -ForegroundColor Yellow
        Write-Host "è¯·åœ¨ GitLab CI/CD Variables ä¸­æ·»åŠ  SSH_PRIVATE_KEYï¼ˆç±»å‹ä¸º Variableï¼‰"
        exit 1
      }
      
      # æµ‹è¯•æœåŠ¡å™¨è¿é€šæ€§
      Write-Host "ğŸ”Œ æµ‹è¯•æœåŠ¡å™¨è¿é€šæ€§..."
      if (Test-Connection -ComputerName $env:SERVER_IP -Count 1 -Quiet -ErrorAction SilentlyContinue) {
        Write-Host "âœ… æœåŠ¡å™¨å¯ä»¥è¿é€š"
      } else {
        Write-Host "âŒ æ— æ³• ping é€šæœåŠ¡å™¨: $($env:SERVER_IP)" -ForegroundColor Red
        exit 1
      }
  script:
    - |
      Write-Host "ğŸš€ åŠè‡ªåŠ¨éƒ¨ç½²åˆ°é˜¿é‡Œäº‘" -ForegroundColor Cyan
      Write-Host "================================="
      
      $server = $env:SERVER_IP
      $user = $env:SERVER_USER
      $deployPath = $env:DEPLOY_PATH
      $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
      $sshKeyPath = "$env:USERPROFILE\.ssh\id_rsa"
      
      # å‚æ•°æ ¡éªŒ
      if ([string]::IsNullOrWhiteSpace($server) -or [string]::IsNullOrWhiteSpace($user) -or [string]::IsNullOrWhiteSpace($deployPath)) {
        Write-Host "âŒ ç¼ºå°‘å¿…è¦çš„ç¯å¢ƒå˜é‡: SERVER_IP, SERVER_USER, DEPLOY_PATH" -ForegroundColor Red
        exit 1
      }
      
      Write-Host "æœåŠ¡å™¨: ${user}@${server}"
      Write-Host "è·¯å¾„: ${deployPath}"
      Write-Host "æ—¶é—´æˆ³: ${timestamp}"
      Write-Host ""
      
      if (Test-Path $sshKeyPath) {
        Write-Host "ğŸ” æ£€æµ‹åˆ° SSH å¯†é’¥ï¼Œå¼€å§‹è‡ªåŠ¨éƒ¨ç½²..." -ForegroundColor Green
        Write-Host "ğŸ’¡ æ‰‹åŠ¨ä½œä¸šå·²è§¦å‘ï¼Œè‡ªåŠ¨ç»§ç»­éƒ¨ç½²..." -ForegroundColor Green
        
        # 1. å¤‡ä»½
        Write-Host "`n1. å¤‡ä»½ç°æœ‰ä»£ç ..." -ForegroundColor Yellow
        ssh -i "$sshKeyPath" -o StrictHostKeyChecking=no -o UserKnownHostsFile=NUL "${user}@${server}" "cd '${deployPath}' && tar -czf backup_${timestamp}.tar.gz backend frontend 2>/dev/null || echo 'é¦–æ¬¡éƒ¨ç½²ï¼Œè·³è¿‡å¤‡ä»½'"
        
        # 2. ä¸Šä¼ åç«¯
        if (Test-Path "back") {
          Write-Host "`n2. ä¸Šä¼ åç«¯ä»£ç ..." -ForegroundColor Yellow
          scp -i "$sshKeyPath" -r -o StrictHostKeyChecking=no -o UserKnownHostsFile=NUL back/* "${user}@${server}:${deployPath}/backend/"
          Write-Host "âœ… åç«¯ä¸Šä¼ å®Œæˆ" -ForegroundColor Green
        }
        
        # 3. ä¸Šä¼ å‰ç«¯
        if (Test-Path "front") {
          Write-Host "`n3. ä¸Šä¼ å‰ç«¯ä»£ç ..." -ForegroundColor Yellow
          scp -i "$sshKeyPath" -r -o StrictHostKeyChecking=no -o UserKnownHostsFile=NUL front/* "${user}@${server}:${deployPath}/frontend/"
          Write-Host "âœ… å‰ç«¯ä¸Šä¼ å®Œæˆ" -ForegroundColor Green
        }
        
        # 4. å®‰è£…ä¾èµ–å¹¶é‡å¯æœåŠ¡
        Write-Host "`n4. å®‰è£…ä¾èµ–å¹¶é‡å¯æœåŠ¡..." -ForegroundColor Yellow
        ssh -i "$sshKeyPath" -o StrictHostKeyChecking=no -o UserKnownHostsFile=NUL "${user}@${server}" "cd '${deployPath}/backend' && npm install --production && pm2 restart all"
        
        Write-Host "`nâœ… éƒ¨ç½²å®Œæˆï¼" -ForegroundColor Green
        Write-Host "ğŸŒ è®¿é—®åœ°å€: http://${server}"
        
      } else {
        Write-Host "âŒ æœªæ£€æµ‹åˆ° SSH ç§é’¥ï¼Œä»…æ˜¾ç¤ºæ‰‹åŠ¨å‘½ä»¤" -ForegroundColor Red
        Write-Host "`nğŸ”§ æ‰‹åŠ¨éƒ¨ç½²å‘½ä»¤ï¼š" -ForegroundColor Cyan
        Write-Host "================================="
        Write-Host "# å¤‡ä»½"
        Write-Host "ssh -i ~/.ssh/id_rsa ${user}@${server} 'cd ${deployPath} && tar -czf backup_${timestamp}.tar.gz backend frontend'"
        Write-Host ""
        Write-Host "# ä¸Šä¼ åç«¯"
        Write-Host "scp -i ~/.ssh/id_rsa -r back/* ${user}@${server}:${deployPath}/backend/"
        Write-Host ""
        Write-Host "# ä¸Šä¼ å‰ç«¯"
        Write-Host "scp -i ~/.ssh/id_rsa -r front/* ${user}@${server}:${deployPath}/frontend/"
        Write-Host ""
        Write-Host "# å®‰è£…ä¾èµ–å¹¶é‡å¯"
        Write-Host "ssh -i ~/.ssh/id_rsa ${user}@${server} 'cd ${deployPath}/backend && npm install --production && pm2 restart all'"
        Write-Host "================================="
      }
  tags:
    - local
  only:
    - main
  when: manual