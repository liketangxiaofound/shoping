# .gitlab-ci.yml
stages:
  - validate
  - build
  - test
  - deploy

# é˜¶æ®µ1: ä»£ç éªŒè¯
validate-code:
  stage: validate
  script:
    - echo "ğŸ” å¼€å§‹ä»£ç è¯­æ³•æ£€æŸ¥..."
    - echo "================================="
    - |
      # æ£€æŸ¥åç«¯ç›®å½•æ˜¯å¦å­˜åœ¨
      if (Test-Path "back") {
        Write-Host "æ£€æŸ¥åç«¯ä»£ç  (back/)..."
        cd back
        $jsFiles = Get-ChildItem -Recurse -Filter *.js
        Write-Host "æ‰¾åˆ°JavaScriptæ–‡ä»¶: $($jsFiles.Count)"
        
        # æ£€æŸ¥è¯­æ³•é”™è¯¯
        Write-Host "æ£€æŸ¥è¯­æ³•é”™è¯¯..."
        $errorCount = 0
        foreach ($file in $jsFiles) {
          if (node -c $file.FullName 2>$null) {
            Write-Host "  âœ… $($file.Name) - è¯­æ³•æ­£ç¡®"
          } else {
            Write-Host "  âŒ $($file.Name) - è¯­æ³•é”™è¯¯"
            $errorCount++
          }
        }
        
        if ($errorCount -eq 0) {
          Write-Host "âœ… åç«¯ä»£ç è¯­æ³•æ£€æŸ¥é€šè¿‡"
        } else {
          Write-Host "âš ï¸  å‘ç° $errorCount ä¸ªè¯­æ³•é”™è¯¯"
        }
        cd ..
      } else {
        Write-Host "âš ï¸  åç«¯ç›®å½•ä¸å­˜åœ¨"
      }
    - echo "================================="
  tags:
    - local
  only:
    - main
  allow_failure: false

# é˜¶æ®µ2: æ„å»º
build-job:
  stage: build
  script:
    - echo "ç¼–è¯‘ä»£ç ..."
    - echo "ç¼–è¯‘å®Œæˆã€‚"
    - |
     if (Test-Path "back") {
        Write-Host "å®‰è£…åç«¯ä¾èµ–..."
        cd back
        npm install
        cd ..
        Write-Host "âœ… åç«¯ä¾èµ–å®‰è£…å®Œæˆ"
      }
     # 2. æ„å»ºå‰ç«¯ï¼ˆå¦‚æœæœ‰ï¼‰
    - |
      if (Test-Path "front") {
        Write-Host "æ„å»ºå‰ç«¯..."
        cd front
        npm install
        npm run build
        cd ..
        Write-Host "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
      }
  tags:
    - local
  only:
    - main

# é˜¶æ®µ3: æµ‹è¯•
unit-test-job:
  stage: test
  script:
    - echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
    - echo "æµ‹è¯•å®Œæˆã€‚"
  tags:
    - local
  only:
    - main
  allow_failure: true

# é˜¶æ®µ4: åŠè‡ªåŠ¨éƒ¨ç½²ï¼ˆéœ€è¦SSHé…ç½®ï¼‰
deploy-semi-auto:
  stage: deploy
  before_script:
    - |
      Write-Host "ğŸ› ï¸ é…ç½® SSH ç¯å¢ƒ..." -ForegroundColor Cyan
      
      $sshDir = "$env:USERPROFILE\.ssh"
      if (-not (Test-Path $sshDir)) {
        New-Item -ItemType Directory -Path $sshDir | Out-Null
      }
      
      # è®¾ç½® .ssh ç›®å½•æƒé™ï¼ˆä»…å½“å‰ç”¨æˆ·ï¼‰
      icacls $sshDir /inheritance:r /grant:r "$env:USERNAME:(F)" | Out-Null
      
      # æ£€æŸ¥ SSH_PRIVATE_KEY
      if ($env:SSH_PRIVATE_KEY) {
        Write-Host "âœ… æ‰¾åˆ° SSH_PRIVATE_KEY å˜é‡"
        $keyFile = "$sshDir\id_rsa"
        Set-Content -Path $keyFile -Value $env:SSH_PRIVATE_KEY -NoNewline
        
        # è®¾ç½®ç§é’¥æƒé™ï¼ˆä»…å½“å‰ç”¨æˆ·è¯»å†™ï¼‰
        icacls $keyFile /inheritance:r /grant:r "$env:USERNAME:(R,W)" | Out-Null
        Write-Host "âœ… SSH ç§é’¥å·²é…ç½®"
      } else {
        Write-Host "âš ï¸ æœªè®¾ç½® SSH_PRIVATE_KEY å˜é‡" -ForegroundColor Yellow
        Write-Host "è¯·åœ¨ GitLab CI/CD Variables ä¸­æ·»åŠ  SSH_PRIVATE_KEYï¼ˆç±»å‹ä¸º Variableï¼‰"
        exit 1
      }
      
      # æµ‹è¯•æœåŠ¡å™¨è¿é€šæ€§
      Write-Host "ğŸ”Œ æµ‹è¯•æœåŠ¡å™¨è¿é€šæ€§..."
      if (Test-Connection -ComputerName $env:SERVER_IP -Count 1 -Quiet -ErrorAction SilentlyContinue) {
        Write-Host "âœ… æœåŠ¡å™¨å¯ä»¥è¿é€š"
      } else {
        Write-Host "âŒ æ— æ³• ping é€šæœåŠ¡å™¨: $($env:SERVER_IP)" -ForegroundColor Red
        exit 1
      }
  script:
    - |
      Write-Host "ğŸš€ åŠè‡ªåŠ¨éƒ¨ç½²åˆ°é˜¿é‡Œäº‘" -ForegroundColor Cyan
      Write-Host "================================="
      
      $server = $env:SERVER_IP
      $user = $env:SERVER_USER
      $deployPath = $env:DEPLOY_PATH
      $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
      $sshKeyPath = "$env:USERPROFILE\.ssh\id_rsa"
      
      # å‚æ•°æ ¡éªŒ
      if ([string]::IsNullOrWhiteSpace($server) -or [string]::IsNullOrWhiteSpace($user) -or [string]::IsNullOrWhiteSpace($deployPath)) {
        Write-Host "âŒ ç¼ºå°‘å¿…è¦çš„ç¯å¢ƒå˜é‡: SERVER_IP, SERVER_USER, DEPLOY_PATH" -ForegroundColor Red
        exit 1
      }
      
      Write-Host "æœåŠ¡å™¨: ${user}@${server}"
      Write-Host "è·¯å¾„: ${deployPath}"
      Write-Host "æ—¶é—´æˆ³: ${timestamp}"
      Write-Host ""
      
      if (Test-Path $sshKeyPath) {
        Write-Host "ğŸ” æ£€æµ‹åˆ° SSH å¯†é’¥ï¼Œå¼€å§‹è‡ªåŠ¨éƒ¨ç½²..." -ForegroundColor Green
        Write-Host "ğŸ’¡ æ‰‹åŠ¨ä½œä¸šå·²è§¦å‘ï¼Œè‡ªåŠ¨ç»§ç»­éƒ¨ç½²..." -ForegroundColor Green
        
        # 1. å¤‡ä»½
        Write-Host "`n1. å¤‡ä»½ç°æœ‰ä»£ç ..." -ForegroundColor Yellow
        ssh -i "$sshKeyPath" -o StrictHostKeyChecking=no -o UserKnownHostsFile=NUL "${user}@${server}" "cd '${deployPath}' && tar -czf backup_${timestamp}.tar.gz backend frontend 2>/dev/null || echo 'é¦–æ¬¡éƒ¨ç½²ï¼Œè·³è¿‡å¤‡ä»½'"
        
        # 2. ä¸Šä¼ åç«¯
        if (Test-Path "back") {
          Write-Host "`n2. ä¸Šä¼ åç«¯ä»£ç ..." -ForegroundColor Yellow
          scp -i "$sshKeyPath" -r -o StrictHostKeyChecking=no -o UserKnownHostsFile=NUL back/* "${user}@${server}:${deployPath}/backend/"
          Write-Host "âœ… åç«¯ä¸Šä¼ å®Œæˆ" -ForegroundColor Green
        }
        
        # 3. ä¸Šä¼ å‰ç«¯
        if (Test-Path "front") {
          Write-Host "`n3. ä¸Šä¼ å‰ç«¯ä»£ç ..." -ForegroundColor Yellow
          scp -i "$sshKeyPath" -r -o StrictHostKeyChecking=no -o UserKnownHostsFile=NUL front/* "${user}@${server}:${deployPath}/frontend/"
          Write-Host "âœ… å‰ç«¯ä¸Šä¼ å®Œæˆ" -ForegroundColor Green
        }
        
        # 4. å®‰è£…ä¾èµ–å¹¶é‡å¯æœåŠ¡
        Write-Host "`n4. å®‰è£…ä¾èµ–å¹¶é‡å¯æœåŠ¡..." -ForegroundColor Yellow
        ssh -i "$sshKeyPath" -o StrictHostKeyChecking=no -o UserKnownHostsFile=NUL "${user}@${server}" "cd '${deployPath}/backend' && npm install --production && pm2 restart all"
        
        Write-Host "`nâœ… éƒ¨ç½²å®Œæˆï¼" -ForegroundColor Green
        Write-Host "ğŸŒ è®¿é—®åœ°å€: http://${server}"
        
      } else {
        Write-Host "âŒ æœªæ£€æµ‹åˆ° SSH ç§é’¥ï¼Œä»…æ˜¾ç¤ºæ‰‹åŠ¨å‘½ä»¤" -ForegroundColor Red
        Write-Host "`nğŸ”§ æ‰‹åŠ¨éƒ¨ç½²å‘½ä»¤ï¼š" -ForegroundColor Cyan
        Write-Host "================================="
        Write-Host "# å¤‡ä»½"
        Write-Host "ssh -i ~/.ssh/id_rsa ${user}@${server} 'cd ${deployPath} && tar -czf backup_${timestamp}.tar.gz backend frontend'"
        Write-Host ""
        Write-Host "# ä¸Šä¼ åç«¯"
        Write-Host "scp -i ~/.ssh/id_rsa -r back/* ${user}@${server}:${deployPath}/backend/"
        Write-Host ""
        Write-Host "# ä¸Šä¼ å‰ç«¯"
        Write-Host "scp -i ~/.ssh/id_rsa -r front/* ${user}@${server}:${deployPath}/frontend/"
        Write-Host ""
        Write-Host "# å®‰è£…ä¾èµ–å¹¶é‡å¯"
        Write-Host "ssh -i ~/.ssh/id_rsa ${user}@${server} 'cd ${deployPath}/backend && npm install --production && pm2 restart all'"
        Write-Host "================================="
      }
  tags:
    - local
  only:
    - main
  when: manual


# é˜¶æ®µ5: å…¨è‡ªåŠ¨éƒ¨ç½²ï¼ˆä¿®å¤ TEMP è·¯å¾„å’Œæƒé™é—®é¢˜ï¼‰
deploy-auto:
  stage: deploy
  before_script:
    - |
      Write-Host "ğŸš€ å…¨è‡ªåŠ¨éƒ¨ç½²åˆå§‹åŒ–..." -ForegroundColor Cyan
      
      # ğŸ”§ å…³é”®ä¿®å¤1: ä½¿ç”¨çœŸæ­£çš„ç”¨æˆ· TEMP ç›®å½•
      # ä¼˜å…ˆä½¿ç”¨ USERPROFILE ä¸‹çš„ä¸´æ—¶ç›®å½•ï¼Œé¿å…æƒé™é—®é¢˜
      $userTemp = [System.IO.Path]::Combine($env:USERPROFILE, "AppData", "Local", "Temp")
      if (-not (Test-Path $userTemp)) {
        $userTemp = $env:TEMP
      }
      
      # ğŸ”§ å…³é”®ä¿®å¤2: ä½¿ç”¨éšæœºæ–‡ä»¶åï¼Œé¿å…å†²çª
      $random = Get-Random -Minimum 1000 -Maximum 9999
      $timestamp = Get-Date -Format "yyyyMMddHHmmss"
      $sshKeyPath = [System.IO.Path]::Combine($userTemp, "gitlab_deploy_key_${timestamp}_${random}")
      
      Write-Host "â„¹ï¸  ä½¿ç”¨å®‰å…¨ä¸´æ—¶è·¯å¾„: $sshKeyPath" -ForegroundColor DarkGray
      
      # === æ£€æŸ¥å¿…è¦ç¯å¢ƒå˜é‡ ===
      $requiredVars = @("SERVER_IP", "SERVER_USER", "DEPLOY_PATH", "SSH_PRIVATE_KEY")
      $missingVars = @()
      foreach ($var in $requiredVars) {
        $value = Get-Item "env:$var" -ErrorAction SilentlyContinue
        if (-not $value -or [string]::IsNullOrWhiteSpace($value.Value)) {
          $missingVars += $var
        }
      }
      
      if ($missingVars.Count -gt 0) {
        Write-Host "âŒ ç¼ºå°‘ä»¥ä¸‹ GitLab CI/CD å˜é‡: $($missingVars -join ', ')" -ForegroundColor Red
        Write-Host "è¯·åœ¨é¡¹ç›® Settings â†’ CI/CD â†’ Variables ä¸­è®¾ç½®å®ƒä»¬" -ForegroundColor Yellow
        exit 1
      }
      
      Write-Host "âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥é€šè¿‡" -ForegroundColor Green
      
      # === æ ‡å‡†åŒ–ç§é’¥ï¼šä¿®å¤æ¢è¡Œç¬¦ ===
      $rawKey = $env:SSH_PRIVATE_KEY
      Write-Host "ğŸ” åŸå§‹ç§é’¥é•¿åº¦: $($rawKey.Length) å­—ç¬¦" -ForegroundColor DarkGray
      
      $normalizedKey = $rawKey -replace "`r`n", "`n" -replace "`r", "`n"
      if (-not $normalizedKey.EndsWith("`n")) {
        $normalizedKey += "`n"
      }
      
      # === å†™å…¥ç§é’¥ï¼ˆUTF-8 æ—  BOMï¼‰===
      try {
        $bytes = [System.Text.Encoding]::UTF8.GetBytes($normalizedKey)
        [System.IO.File]::WriteAllBytes($sshKeyPath, $bytes)
        Write-Host "âœ… ç§é’¥å·²å†™å…¥ä¸´æ—¶æ–‡ä»¶" -ForegroundColor Green
        
        # ğŸ”§ å…³é”®ä¿®å¤3: æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æˆåŠŸå†™å…¥
        if (-not (Test-Path $sshKeyPath)) {
          Write-Host "âŒ ç§é’¥æ–‡ä»¶å†™å…¥å¤±è´¥" -ForegroundColor Red
          exit 1
        }
        
        $fileSize = (Get-Item $sshKeyPath).Length
        Write-Host "ğŸ“ æ–‡ä»¶å¤§å°: $fileSize å­—èŠ‚" -ForegroundColor DarkGray
        
      } catch {
        Write-Host "âŒ å†™å…¥ç§é’¥å¤±è´¥: $_" -ForegroundColor Red
        Write-Host "ğŸ’¡ å¯èƒ½æ˜¯æƒé™é—®é¢˜ï¼Œå°è¯•ä½¿ç”¨å…¶ä»–ç›®å½•..." -ForegroundColor Yellow
        
        # å°è¯•å¤‡ç”¨ç›®å½•
        $sshKeyPath = [System.IO.Path]::Combine($env:USERPROFILE, "gitlab_deploy_key_${timestamp}_${random}")
        $bytes = [System.Text.Encoding]::UTF8.GetBytes($normalizedKey)
        [System.IO.File]::WriteAllBytes($sshKeyPath, $bytes)
        Write-Host "âœ… ç§é’¥å·²å†™å…¥å¤‡ç”¨è·¯å¾„" -ForegroundColor Green
      }
      
      # === è°ƒè¯•ï¼šæ£€æŸ¥é¦–è¡Œ ===
      $firstLine = Get-Content -Path $sshKeyPath -First 1 -Encoding UTF8
      Write-Host "ğŸ” ç§é’¥é¦–è¡Œ: $firstLine" -ForegroundColor Magenta
      
      # ğŸ”§ å…³é”®ä¿®å¤4: ä½¿ç”¨æ›´ç®€å•çš„æƒé™è®¾ç½®ï¼Œé¿å…å¤æ‚çš„ icacls
      Write-Host "ğŸ”’ è®¾ç½®æ–‡ä»¶æƒé™..." -ForegroundColor Yellow
      
      # æ–¹æ³•1: ä½¿ç”¨ PowerShell çš„ ACL
      try {
        $acl = Get-Acl -Path $sshKeyPath
        $acl.SetAccessRuleProtection($true, $false)  # ç¦ç”¨ç»§æ‰¿
        Set-Acl -Path $sshKeyPath -AclObject $acl
        Write-Host "âœ… ä½¿ç”¨ PowerShell ACL è®¾ç½®æƒé™" -ForegroundColor Green
      } catch {
        Write-Host "âš ï¸  PowerShell ACL è®¾ç½®å¤±è´¥: $_" -ForegroundColor Yellow
        Write-Host "â„¹ï¸  å°è¯•ä½¿ç”¨ç®€å•æ–¹æ³•..." -ForegroundColor Gray
      }
      
      # è®¾ç½®ä¸ºéšè—æ–‡ä»¶
      attrib +h $sshKeyPath 2>$null
      
      # === æµ‹è¯•æœåŠ¡å™¨è¿é€šæ€§ ===
      Write-Host "ğŸ“¡ æµ‹è¯•æœåŠ¡å™¨è¿é€šæ€§ ($($env:SERVER_IP))..." -ForegroundColor Yellow
      $pingSuccess = $false
      for ($i = 1; $i -le 3; $i++) {
        Write-Host "å°è¯• $i/3..."
        if (Test-Connection -ComputerName $env:SERVER_IP -Count 1 -Quiet -ErrorAction SilentlyContinue) {
          $pingSuccess = $true
          Write-Host "âœ… æœåŠ¡å™¨å¯è¾¾" -ForegroundColor Green
          break
        }
        Start-Sleep -Seconds 2
      }
      
      if (-not $pingSuccess) {
        Write-Host "âŒ æ— æ³• ping é€š $($env:SERVER_IP)" -ForegroundColor Red
        exit 1
      }
      
      # === æµ‹è¯• SSH è¿æ¥ ===
      Write-Host "ğŸ”‘ æµ‹è¯• SSH è®¤è¯..." -ForegroundColor Yellow
      
      # ä½¿ç”¨ Job æ§åˆ¶è¶…æ—¶
      $job = Start-Job -ScriptBlock {
        param($keyPath, $user, $server)
        ssh -i $keyPath -o ConnectTimeout=10 -o BatchMode=yes -o StrictHostKeyChecking=no "${user}@${server}" "echo 'SSH_OK'" 2>&1
      } -ArgumentList $sshKeyPath, $env:SERVER_USER, $env:SERVER_IP
      
      $result = Wait-Job $job -Timeout 15
      
      if ($result) {
        $output = Receive-Job $job
        if ($output -like "*SSH_OK*") {
          Write-Host "âœ… SSH è¿æ¥æˆåŠŸ" -ForegroundColor Green
          [System.Environment]::SetEnvironmentVariable("GITLAB_SSH_KEY_PATH", $sshKeyPath, "Process")
        } else {
          Write-Host "âŒ SSH è¿æ¥å¤±è´¥" -ForegroundColor Red
          Write-Host "è¾“å‡º: $output" -ForegroundColor Gray
          exit 1
        }
      } else {
        Write-Host "âŒ SSH è¿æ¥è¶…æ—¶" -ForegroundColor Red
        Stop-Job $job
        exit 1
      }
      
      Remove-Job $job
      
      Write-Host "âœ… åˆå§‹åŒ–å®Œæˆï¼Œå‡†å¤‡éƒ¨ç½²" -ForegroundColor Green
  
  script:
    - |
      Write-Host "ğŸ¯ å¼€å§‹å…¨è‡ªåŠ¨éƒ¨ç½²..." -ForegroundColor Green
      Write-Host "================================="
      
      $sshKeyPath = $env:GITLAB_SSH_KEY_PATH
      if (-not $sshKeyPath -or -not (Test-Path $sshKeyPath)) {
        Write-Host "âŒ SSH å¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨: $sshKeyPath" -ForegroundColor Red
        Write-Host "ğŸ’¡ å¯èƒ½ before_script é˜¶æ®µå¤±è´¥" -ForegroundColor Yellow
        exit 1
      }
      
      $server = $env:SERVER_IP
      $user = $env:SERVER_USER
      $deployPath = $env:DEPLOY_PATH
      $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
      
      Write-Host "éƒ¨ç½²ä¿¡æ¯:" -ForegroundColor Cyan
      Write-Host "  - æœåŠ¡å™¨: ${user}@${server}"
      Write-Host "  - éƒ¨ç½²è·¯å¾„: ${deployPath}"
      Write-Host "  - SSH å¯†é’¥: $sshKeyPath"
      Write-Host "  - æ—¶é—´æˆ³: ${timestamp}"
      Write-Host "  - æäº¤: $env:CI_COMMIT_SHORT_SHA"
      Write-Host "  - åˆ†æ”¯: $env:CI_COMMIT_REF_NAME"
      Write-Host ""
      
      # 1. å¤‡ä»½æœåŠ¡å™¨ä»£ç 
      Write-Host "1ï¸âƒ£ å¤‡ä»½æœåŠ¡å™¨ç°æœ‰ä»£ç ..." -ForegroundColor Yellow
      $backupCmd = "cd '${deployPath}' && tar -czf backup_${timestamp}.tar.gz backend frontend 2>/dev/null || echo 'é¦–æ¬¡éƒ¨ç½²ï¼Œæ— éœ€å¤‡ä»½'"
      
      $backupJob = Start-Job -ScriptBlock {
        param($keyPath, $user, $server, $backupCmd)
        ssh -i $keyPath -o BatchMode=yes -o StrictHostKeyChecking=no "${user}@${server}" $backupCmd 2>&1
      } -ArgumentList $sshKeyPath, $user, $server, $backupCmd
      
      $backupResult = Wait-Job $backupJob -Timeout 30
      if ($backupResult) {
        $output = Receive-Job $backupJob
        Write-Host "å¤‡ä»½ç»“æœ: $output" -ForegroundColor Gray
        Write-Host "âœ… å¤‡ä»½å®Œæˆ" -ForegroundColor Green
      } else {
        Write-Host "âš ï¸  å¤‡ä»½å¯èƒ½è¶…æ—¶ï¼Œç»§ç»­æ‰§è¡Œ..." -ForegroundColor Yellow
        Stop-Job $backupJob
      }
      Remove-Job $backupJob
      
      # 2. ä¸Šä¼ åç«¯ä»£ç 
      if (Test-Path "back") {
        Write-Host "`n2ï¸âƒ£ ä¸Šä¼ åç«¯ä»£ç ..." -ForegroundColor Yellow
        $backFileCount = (Get-ChildItem -Recurse -Path "back" | Measure-Object).Count
        Write-Host "å‘ç° $backFileCount ä¸ªæ–‡ä»¶éœ€è¦ä¸Šä¼ " -ForegroundColor Gray
        
        # åˆ›å»ºç›®å½•
        $mkdirJob = Start-Job -ScriptBlock {
          param($keyPath, $user, $server, $deployPath)
          ssh -i $keyPath -o BatchMode=yes -o StrictHostKeyChecking=no "${user}@${server}" "mkdir -p ${deployPath}/backend" 2>&1
        } -ArgumentList $sshKeyPath, $user, $server, $deployPath
        
        Wait-Job $mkdirJob -Timeout 10 | Out-Null
        Remove-Job $mkdirJob
        
        # ä¸Šä¼ æ–‡ä»¶
        $uploadJob = Start-Job -ScriptBlock {
          param($keyPath, $user, $server, $deployPath)
          $currentDir = Get-Location
          $backPath = Join-Path $currentDir "back"
          scp -i $keyPath -r -o BatchMode=yes "${backPath}/*" "${user}@${server}:${deployPath}/backend/" 2>&1
        } -ArgumentList $sshKeyPath, $user, $server, $deployPath
        
        $uploadResult = Wait-Job $uploadJob -Timeout 60
        if ($uploadResult) {
          $output = Receive-Job $uploadJob
          if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ… åç«¯ä»£ç ä¸Šä¼ å®Œæˆ" -ForegroundColor Green
          } else {
            Write-Host "âŒ åç«¯ä»£ç ä¸Šä¼ å¤±è´¥: $output" -ForegroundColor Red
          }
        } else {
          Write-Host "âš ï¸  ä¸Šä¼ è¶…æ—¶ï¼Œç»§ç»­æ‰§è¡Œ..." -ForegroundColor Yellow
          Stop-Job $uploadJob
        }
        Remove-Job $uploadJob
      } else {
        Write-Host "âš ï¸  backç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡åç«¯éƒ¨ç½²" -ForegroundColor Yellow
      }
      
      # 3. ä¸Šä¼ å‰ç«¯ä»£ç 
      if (Test-Path "front") {
        Write-Host "`n3ï¸âƒ£ ä¸Šä¼ å‰ç«¯ä»£ç ..." -ForegroundColor Yellow
        $frontFileCount = (Get-ChildItem -Recurse -Path "front" | Measure-Object).Count
        Write-Host "å‘ç° $frontFileCount ä¸ªæ–‡ä»¶éœ€è¦ä¸Šä¼ " -ForegroundColor Gray
        
        # åˆ›å»ºç›®å½•
        $mkdirJob = Start-Job -ScriptBlock {
          param($keyPath, $user, $server, $deployPath)
          ssh -i $keyPath -o BatchMode=yes -o StrictHostKeyChecking=no "${user}@${server}" "mkdir -p ${deployPath}/frontend" 2>&1
        } -ArgumentList $sshKeyPath, $user, $server, $deployPath
        
        Wait-Job $mkdirJob -Timeout 10 | Out-Null
        Remove-Job $mkdirJob
        
        # ä¸Šä¼ æ–‡ä»¶
        $uploadJob = Start-Job -ScriptBlock {
          param($keyPath, $user, $server, $deployPath)
          $currentDir = Get-Location
          $frontPath = Join-Path $currentDir "front"
          scp -i $keyPath -r -o BatchMode=yes "${frontPath}/*" "${user}@${server}:${deployPath}/frontend/" 2>&1
        } -ArgumentList $sshKeyPath, $user, $server, $deployPath
        
        $uploadResult = Wait-Job $uploadJob -Timeout 60
        if ($uploadResult) {
          $output = Receive-Job $uploadJob
          if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ… å‰ç«¯ä»£ç ä¸Šä¼ å®Œæˆ" -ForegroundColor Green
          } else {
            Write-Host "âŒ å‰ç«¯ä»£ç ä¸Šä¼ å¤±è´¥: $output" -ForegroundColor Red
          }
        } else {
          Write-Host "âš ï¸  ä¸Šä¼ è¶…æ—¶ï¼Œç»§ç»­æ‰§è¡Œ..." -ForegroundColor Yellow
          Stop-Job $uploadJob
        }
        Remove-Job $uploadJob
      } else {
        Write-Host "âš ï¸  frontç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡å‰ç«¯éƒ¨ç½²" -ForegroundColor Yellow
      }
      
      # 4. å®‰è£…ä¾èµ–å¹¶é‡å¯æœåŠ¡
      Write-Host "`n4ï¸âƒ£ å®‰è£…ä¾èµ–å¹¶é‡å¯æœåŠ¡..." -ForegroundColor Yellow
      $restartCmd = @"
        cd '${deployPath}/backend'
        npm install --production
        pm2 restart all || pm2 start npm --name 'backend' -- run start
      "@
      
      $restartJob = Start-Job -ScriptBlock {
        param($keyPath, $user, $server, $restartCmd)
        ssh -i $keyPath -o BatchMode=yes -o StrictHostKeyChecking=no "${user}@${server}" $restartCmd 2>&1
      } -ArgumentList $sshKeyPath, $user, $server, $restartCmd
      
      $restartResult = Wait-Job $restartJob -Timeout 120
      if ($restartResult) {
        $output = Receive-Job $restartJob
        Write-Host "é‡å¯ç»“æœ: $output" -ForegroundColor Gray
        Write-Host "âœ… æœåŠ¡é‡å¯å®Œæˆ" -ForegroundColor Green
      } else {
        Write-Host "âš ï¸  é‡å¯è¶…æ—¶ï¼Œä½†å¯èƒ½å·²æˆåŠŸ" -ForegroundColor Yellow
        Stop-Job $restartJob
      }
      Remove-Job $restartJob
      
      Write-Host "`nğŸ‰ å…¨è‡ªåŠ¨éƒ¨ç½²å®Œæˆï¼" -ForegroundColor Green
      Write-Host "================================="
      Write-Host "ğŸŒ ç½‘ç«™åœ°å€: http://${server}:3000"
      Write-Host "ğŸ“… éƒ¨ç½²æ—¶é—´: $(Get-Date)"
      Write-Host "ğŸ”§ æäº¤å“ˆå¸Œ: $env:CI_COMMIT_SHORT_SHA"
      Write-Host "ğŸŒ¿ åˆ†æ”¯: $env:CI_COMMIT_REF_NAME"
      Write-Host "================================="
  
  after_script:
    - |
      Write-Host "ğŸ§¹ æ¸…ç†ä¸´æ—¶å¯†é’¥..." -ForegroundColor Gray
      
      # å°è¯•ä»ç¯å¢ƒå˜é‡è·å–è·¯å¾„
      $sshKeyPath = $env:GITLAB_SSH_KEY_PATH
      
      # å¦‚æœç¯å¢ƒå˜é‡æ²¡æœ‰ï¼Œå°è¯•æŸ¥æ‰¾ä¸´æ—¶æ–‡ä»¶
      if (-not $sshKeyPath -or -not (Test-Path $sshKeyPath)) {
        # æŸ¥æ‰¾å¯èƒ½çš„ä¸´æ—¶æ–‡ä»¶
        $tempDir = [System.IO.Path]::Combine($env:USERPROFILE, "AppData", "Local", "Temp")
        if (Test-Path $tempDir) {
          $possibleFiles = Get-ChildItem -Path $tempDir -Filter "gitlab_deploy_key_*" -ErrorAction SilentlyContinue
          if ($possibleFiles) {
            $sshKeyPath = $possibleFiles[0].FullName
          }
        }
        
        # å¦‚æœè¿˜æ²¡æœ‰ï¼Œå°è¯•å¦ä¸€ä¸ªç›®å½•
        if (-not $sshKeyPath) {
          $possibleFiles = Get-ChildItem -Path $env:TEMP -Filter "gitlab_deploy_key_*" -ErrorAction SilentlyContinue
          if ($possibleFiles) {
            $sshKeyPath = $possibleFiles[0].FullName
          }
        }
      }
      
      if ($sshKeyPath -and (Test-Path $sshKeyPath)) {
        Write-Host "æ‰¾åˆ°ä¸´æ—¶å¯†é’¥æ–‡ä»¶: $sshKeyPath" -ForegroundColor DarkGray
        
        # ğŸ”§ å…³é”®ä¿®å¤5: ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹æ³•åˆ é™¤æ–‡ä»¶
        try {
          # å…ˆå–æ¶ˆéšè—å±æ€§
          attrib -h $sshKeyPath 2>$null
          
          # å°è¯•ç›´æ¥åˆ é™¤
          Remove-Item -Path $sshKeyPath -Force -ErrorAction Stop
          Write-Host "âœ… ä¸´æ—¶å¯†é’¥å·²åˆ é™¤" -ForegroundColor Green
        } catch {
          Write-Host "âš ï¸  æ— æ³•åˆ é™¤æ–‡ä»¶: $_" -ForegroundColor Yellow
          Write-Host "ğŸ’¡ å°†åœ¨ä¸‹æ¬¡éƒ¨ç½²æ—¶è¦†ç›–" -ForegroundColor Gray
          
          # å¦‚æœæ— æ³•åˆ é™¤ï¼Œè‡³å°‘æ¸…ç©ºæ–‡ä»¶å†…å®¹
          try {
            Set-Content -Path $sshKeyPath -Value "" -NoNewline -ErrorAction Stop
            Write-Host "âœ… å·²æ¸…ç©ºæ–‡ä»¶å†…å®¹" -ForegroundColor Green
          } catch {
            Write-Host "âš ï¸  æ— æ³•æ¸…ç©ºæ–‡ä»¶å†…å®¹" -ForegroundColor Yellow
          }
        }
      } else {
        Write-Host "â„¹ï¸  æœªæ‰¾åˆ°ä¸´æ—¶å¯†é’¥æ–‡ä»¶ï¼Œå¯èƒ½å·²åˆ é™¤" -ForegroundColor Gray
      }
  
  tags:
    - local
  only:
    - main
  when: on_success
  environment:
    name: production
    url: http://$env:SERVER_IP:3000