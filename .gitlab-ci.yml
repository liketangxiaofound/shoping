# .gitlab-ci.yml
stages:
  - validate
  - build
  - test
  - deploy

# é˜¶æ®µ1: ä»£ç éªŒè¯
validate-code:
  stage: validate
  script:
    - echo "ğŸ” å¼€å§‹ä»£ç è¯­æ³•æ£€æŸ¥..."
    - echo "================================="
    - |
      # æ£€æŸ¥åç«¯ç›®å½•æ˜¯å¦å­˜åœ¨
      if (Test-Path "back") {
        Write-Host "æ£€æŸ¥åç«¯ä»£ç  (back/)..."
        cd back
        $jsFiles = Get-ChildItem -Recurse -Filter *.js
        Write-Host "æ‰¾åˆ°JavaScriptæ–‡ä»¶: $($jsFiles.Count)"
        
        # æ£€æŸ¥è¯­æ³•é”™è¯¯
        Write-Host "æ£€æŸ¥è¯­æ³•é”™è¯¯..."
        $errorCount = 0
        foreach ($file in $jsFiles) {
          if (node -c $file.FullName 2>$null) {
            Write-Host "  âœ… $($file.Name) - è¯­æ³•æ­£ç¡®"
          } else {
            Write-Host "  âŒ $($file.Name) - è¯­æ³•é”™è¯¯"
            $errorCount++
          }
        }
        
        if ($errorCount -eq 0) {
          Write-Host "âœ… åç«¯ä»£ç è¯­æ³•æ£€æŸ¥é€šè¿‡"
        } else {
          Write-Host "âš ï¸  å‘ç° $errorCount ä¸ªè¯­æ³•é”™è¯¯"
        }
        cd ..
      } else {
        Write-Host "âš ï¸  åç«¯ç›®å½•ä¸å­˜åœ¨"
      }
    - echo "================================="
  tags:
    - local
  only:
    - main
  allow_failure: false

# é˜¶æ®µ2: æ„å»º
build-job:
  stage: build
  script:
    - echo "ç¼–è¯‘ä»£ç ..."
    - echo "ç¼–è¯‘å®Œæˆã€‚"
    - |
     if (Test-Path "back") {
        Write-Host "å®‰è£…åç«¯ä¾èµ–..."
        cd back
        npm install
        cd ..
        Write-Host "âœ… åç«¯ä¾èµ–å®‰è£…å®Œæˆ"
      }
     # 2. æ„å»ºå‰ç«¯ï¼ˆå¦‚æœæœ‰ï¼‰
    - |
      if (Test-Path "front") {
        Write-Host "æ„å»ºå‰ç«¯..."
        cd front
        npm install
        npm run build
        cd ..
        Write-Host "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
      }
  tags:
    - local
  only:
    - main

# é˜¶æ®µ3: æµ‹è¯•
unit-test-job:
  stage: test
  script:
    - echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
    - echo "æµ‹è¯•å®Œæˆã€‚"
  tags:
    - local
  only:
    - main
  allow_failure: true

# é˜¶æ®µ4: åŠè‡ªåŠ¨éƒ¨ç½²ï¼ˆéœ€è¦SSHé…ç½®ï¼‰
deploy-semi-auto:
  stage: deploy
  before_script:
    # è®¾ç½® SSH
    - echo "ğŸ”§ é…ç½® SSH å¯†é’¥..."
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    
    # å¦‚æœå­˜åœ¨ SSH_PRIVATE_KEY å˜é‡ï¼Œåˆ™ä½¿ç”¨
    - if (Test-Path "$env:SSH_PRIVATE_KEY") {
        echo "âœ… æ‰¾åˆ° SSH ç§é’¥"
        Copy-Item "$env:SSH_PRIVATE_KEY" ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        echo "âœ… SSH ç§é’¥å·²é…ç½®"
      } else {
        echo "âš ï¸  æœªè®¾ç½® SSH_PRIVATE_KEY å˜é‡"
        echo "è¯·å…ˆåœ¨ GitLab CI/CD Variables ä¸­æ·»åŠ  SSH_PRIVATE_KEY"
      }
    
    # æµ‹è¯• SSH è¿æ¥
    - echo "ğŸ”Œ æµ‹è¯•æœåŠ¡å™¨è¿æ¥..."
    - $pingResult = ping -n 1 ${SERVER_IP}
    if ($LASTEXITCODE -eq 0) {
      echo "âœ… æœåŠ¡å™¨å¯ä»¥è¿é€š"
    } else {
      echo "âŒ æ— æ³•è¿æ¥æœåŠ¡å™¨"
      exit 1
    }
  script:
    - |
      Write-Host "ğŸš€ åŠè‡ªåŠ¨éƒ¨ç½²åˆ°é˜¿é‡Œäº‘" -ForegroundColor Cyan
      Write-Host "================================="
      
      $server = "${SERVER_IP}"
      $user = "${SERVER_USER}"
      $deployPath = "${DEPLOY_PATH}"
      $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
      
      Write-Host "æœåŠ¡å™¨: $user@$server"
      Write-Host "è·¯å¾„: $deployPath"
      Write-Host "æ—¶é—´æˆ³: $timestamp"
      Write-Host ""
      
      # æ£€æŸ¥æ˜¯å¦æœ‰ SSH å¯†é’¥
      $hasSshKey = Test-Path "~/.ssh/id_rsa"
      
      if ($hasSshKey) {
        Write-Host "ğŸ” æ£€æµ‹åˆ° SSH å¯†é’¥ï¼Œå¯ä»¥å°è¯•è‡ªåŠ¨ä¸Šä¼ " -ForegroundColor Green
        Write-Host ""
        Write-Host "è¯·ç¡®è®¤æ˜¯å¦ç»§ç»­æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š" -ForegroundColor Yellow
        Write-Host "1. å¤‡ä»½æœåŠ¡å™¨ç°æœ‰ä»£ç "
        Write-Host "2. ä¸Šä¼ åç«¯ä»£ç "
        Write-Host "3. ä¸Šä¼ å‰ç«¯ä»£ç "
        Write-Host "4. è‡ªåŠ¨é‡å¯æœåŠ¡"
        Write-Host ""
        $confirmation = Read-Host "æ˜¯å¦ç»§ç»­? (y/n)"
        
        if ($confirmation -eq 'y') {
          Write-Host "å¼€å§‹æ‰§è¡Œéƒ¨ç½²..." -ForegroundColor Green
          
          # 1. å¤‡ä»½
          Write-Host "`n1. å¤‡ä»½ç°æœ‰ä»£ç ..." -ForegroundColor Yellow
          ssh -o StrictHostKeyChecking=no ${user}@${server} "cd $deployPath && tar -czf backup_$timestamp.tar.gz backend frontend 2>/dev/null || echo 'é¦–æ¬¡éƒ¨ç½²ï¼Œè·³è¿‡å¤‡ä»½'"
          
          # 2. ä¸Šä¼ åç«¯
          if (Test-Path "back") {
            Write-Host "`n2. ä¸Šä¼ åç«¯ä»£ç ..." -ForegroundColor Yellow
            scp -r -o StrictHostKeyChecking=no back/* ${user}@${server}:${deployPath}/backend/
            Write-Host "âœ… åç«¯ä¸Šä¼ å®Œæˆ" -ForegroundColor Green
          }
          
          # 3. ä¸Šä¼ å‰ç«¯
          if (Test-Path "front") {
            Write-Host "`n3. ä¸Šä¼ å‰ç«¯ä»£ç ..." -ForegroundColor Yellow
            scp -r -o StrictHostKeyChecking=no front/* ${user}@${server}:${deployPath}/frontend/
            Write-Host "âœ… å‰ç«¯ä¸Šä¼ å®Œæˆ" -ForegroundColor Green
          }
          
          Write-Host "`nâœ… æ–‡ä»¶ä¸Šä¼ å®Œæˆï¼" -ForegroundColor Green
          Write-Host "`nè¯·åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š" -ForegroundColor Yellow
          Write-Host "ssh ${user}@${server}"
          Write-Host "cd ${deployPath}/backend && npm install --production"
          Write-Host "pm2 restart all"
          
        } else {
          Write-Host "éƒ¨ç½²å·²å–æ¶ˆ" -ForegroundColor Yellow
        }
        
      } else {
        Write-Host "âŒ æœªæ£€æµ‹åˆ° SSH å¯†é’¥ï¼Œä½¿ç”¨æ‰‹åŠ¨éƒ¨ç½²" -ForegroundColor Red
        Write-Host "`nè¯·æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š" -ForegroundColor Yellow
      }
      
      # æ˜¾ç¤ºæ‰‹åŠ¨å‘½ä»¤
      Write-Host "`nğŸ”§ æ‰‹åŠ¨éƒ¨ç½²å‘½ä»¤ï¼š" -ForegroundColor Cyan
      Write-Host "================================="
      Write-Host "# å¤‡ä»½"
      Write-Host "ssh $user@$server 'cd $deployPath && tar -czf backup_$timestamp.tar.gz backend frontend'"
      Write-Host ""
      Write-Host "# ä¸Šä¼ åç«¯"
      Write-Host "scp -r back/* $user@$server`:$deployPath/backend/"
      Write-Host ""
      Write-Host "# ä¸Šä¼ å‰ç«¯"
      Write-Host "scp -r front/* $user@$server`:$deployPath/frontend/"
      Write-Host ""
      Write-Host "# å®‰è£…ä¾èµ–å¹¶é‡å¯"
      Write-Host "ssh $user@$server 'cd $deployPath/backend && npm install --production && pm2 restart all'"
      Write-Host "================================="
  tags:
    - local
  only:
    - main
  when: manual