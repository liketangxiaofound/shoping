# .gitlab-ci.yml
stages:
  - validate
  - build
  - test
  - deploy

# é˜¶æ®µ1: ä»£ç éªŒè¯
validate-code:
  stage: validate
  script:
    - echo "ğŸ” å¼€å§‹ä»£ç è¯­æ³•æ£€æŸ¥..."
    - echo "================================="
    - |
      # æ£€æŸ¥åç«¯ç›®å½•æ˜¯å¦å­˜åœ¨
      if (Test-Path "back") {
        Write-Host "æ£€æŸ¥åç«¯ä»£ç  (back/)..."
        cd back
        $jsFiles = Get-ChildItem -Recurse -Filter *.js
        Write-Host "æ‰¾åˆ°JavaScriptæ–‡ä»¶: $($jsFiles.Count)"
        
        # æ£€æŸ¥è¯­æ³•é”™è¯¯
        Write-Host "æ£€æŸ¥è¯­æ³•é”™è¯¯..."
        $errorCount = 0
        foreach ($file in $jsFiles) {
          if (node -c $file.FullName 2>$null) {
            Write-Host "  âœ… $($file.Name) - è¯­æ³•æ­£ç¡®"
          } else {
            Write-Host "  âŒ $($file.Name) - è¯­æ³•é”™è¯¯"
            $errorCount++
          }
        }
        
        if ($errorCount -eq 0) {
          Write-Host "âœ… åç«¯ä»£ç è¯­æ³•æ£€æŸ¥é€šè¿‡"
        } else {
          Write-Host "âš ï¸  å‘ç° $errorCount ä¸ªè¯­æ³•é”™è¯¯"
        }
        cd ..
      } else {
        Write-Host "âš ï¸  åç«¯ç›®å½•ä¸å­˜åœ¨"
      }
    - echo "================================="
  tags:
    - local
  only:
    - main
  allow_failure: false

# é˜¶æ®µ2: æ„å»º
build-job:
  stage: build
  script:
    - echo "ç¼–è¯‘ä»£ç ..."
    - echo "ç¼–è¯‘å®Œæˆã€‚"
    - |
     if (Test-Path "back") {
        Write-Host "å®‰è£…åç«¯ä¾èµ–..."
        cd back
        npm install
        cd ..
        Write-Host "âœ… åç«¯ä¾èµ–å®‰è£…å®Œæˆ"
      }
     # 2. æ„å»ºå‰ç«¯ï¼ˆå¦‚æœæœ‰ï¼‰
    - |
      if (Test-Path "front") {
        Write-Host "æ„å»ºå‰ç«¯..."
        cd front
        npm install
        npm run build
        cd ..
        Write-Host "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
      }
  tags:
    - local
  only:
    - main

# é˜¶æ®µ3: æµ‹è¯•
unit-test-job:
  stage: test
  script:
    - echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
    - echo "æµ‹è¯•å®Œæˆã€‚"
  tags:
    - local
  only:
    - main
  allow_failure: true

# é˜¶æ®µ4: éƒ¨ç½²ï¼ˆå¢åŠ æœåŠ¡å™¨è¿é€šæ€§æ£€æŸ¥ï¼‰
deploy-check:
  stage: deploy
  before_script:
    # å®‰è£…pingå·¥å…·ï¼ˆWindowsè‡ªå¸¦ï¼‰
    - echo "ğŸ› ï¸ å‡†å¤‡éƒ¨ç½²ç¯å¢ƒ..."
  script:
    - |
      Write-Host "ğŸš€ éƒ¨ç½²åˆ°é˜¿é‡Œäº‘ ECS" -ForegroundColor Cyan
      Write-Host "================================="
      
      $server = "${SERVER_IP}"
      $user = "${SERVER_USER}"
      $deployPath = "${DEPLOY_PATH}"
      
      Write-Host "æœåŠ¡å™¨ä¿¡æ¯:" -ForegroundColor Yellow
      Write-Host "  IP: $server"
      Write-Host "  ç”¨æˆ·å: $user"
      Write-Host "  éƒ¨ç½²è·¯å¾„: $deployPath"
      
      # 1. æµ‹è¯•æœåŠ¡å™¨è¿é€šæ€§
      Write-Host "`nğŸ”Œ æµ‹è¯•æœåŠ¡å™¨è¿é€šæ€§..." -ForegroundColor Green
      $pingResult = Test-Connection -ComputerName $server -Count 2 -Quiet
      if ($pingResult) {
        Write-Host "  âœ… æœåŠ¡å™¨å¯ä»¥è¿é€š" -ForegroundColor Green
      } else {
        Write-Host "  âŒ æ— æ³•pingé€šæœåŠ¡å™¨" -ForegroundColor Red
        Write-Host "  è¯·æ£€æŸ¥:"
        Write-Host "  - æœåŠ¡å™¨IPæ˜¯å¦æ­£ç¡®: $server"
        Write-Host "  - æœåŠ¡å™¨æ˜¯å¦å¼€æœº"
        Write-Host "  - é˜²ç«å¢™è®¾ç½®"
        exit 1
      }
      
      # 2. æµ‹è¯•SSHè¿æ¥
      Write-Host "`nğŸ” æµ‹è¯•SSHè¿æ¥..." -ForegroundColor Green
      $sshTest = ssh -o ConnectTimeout=5 -o BatchMode=yes -o StrictHostKeyChecking=no ${user}@${server} "echo 'SSHè¿æ¥æˆåŠŸ'" 2>&1
      if ($? -and $sshTest -like "*SSHè¿æ¥æˆåŠŸ*") {
        Write-Host "  âœ… SSHè¿æ¥æˆåŠŸ" -ForegroundColor Green
      } else {
        Write-Host "  âš ï¸  SSHè¿æ¥æµ‹è¯•å¤±è´¥" -ForegroundColor Yellow
        Write-Host "  å¦‚æœä½¿ç”¨å¯†ç ç™»å½•ï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œä»¥ä¸‹å‘½ä»¤:"
        Write-Host "  ssh $user@$server"
      }
      
      # 3. æ£€æŸ¥ç›®å½•ç»“æ„
      Write-Host "`nğŸ“ æ£€æŸ¥ç›®å½•ç»“æ„..." -ForegroundColor Green
      if (Test-Path "back") {
        $backFiles = (Get-ChildItem -Recurse -Path "back" | Measure-Object).Count
        Write-Host "  âœ… åç«¯ç›®å½•: back/ ($backFiles ä¸ªæ–‡ä»¶)" -ForegroundColor Green
      } else {
        Write-Host "  âŒ åç«¯ç›®å½• back/ ä¸å­˜åœ¨" -ForegroundColor Red
        exit 1
      }
      
      if (Test-Path "front") {
        $frontFiles = (Get-ChildItem -Recurse -Path "front" | Measure-Object).Count
        Write-Host "  âœ… å‰ç«¯ç›®å½•: front/ ($frontFiles ä¸ªæ–‡ä»¶)" -ForegroundColor Green
      } else {
        Write-Host "  âš ï¸  å‰ç«¯ç›®å½• front/ ä¸å­˜åœ¨" -ForegroundColor Yellow
      }
      
      Write-Host "`nğŸ“ ç›®å½•æ˜ å°„:" -ForegroundColor Yellow
      Write-Host "   æœ¬åœ° back/  â†’ æœåŠ¡å™¨ ${SERVER_USER}@${SERVER_IP}:${DEPLOY_PATH}/backend/"
      Write-Host "   æœ¬åœ° front/ â†’ æœåŠ¡å™¨ ${SERVER_USER}@${SERVER_IP}:${DEPLOY_PATH}/frontend/"
      
      Write-Host "`nğŸ”§ éƒ¨ç½²å‘½ä»¤:" -ForegroundColor Yellow
      Write-Host ""
      Write-Host "# 1. å¤‡ä»½ç°æœ‰ä»£ç ï¼ˆæ¨èï¼‰" -ForegroundColor Green
      $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
      Write-Host "ssh ${SERVER_USER}@${SERVER_IP} 'cd ${DEPLOY_PATH} && tar -czf backup_$timestamp.tar.gz backend frontend'"
      Write-Host ""
      Write-Host "# 2. ä¸Šä¼ åç«¯ä»£ç " -ForegroundColor Green
      Write-Host "scp -r back/* ${SERVER_USER}@${SERVER_IP}:${DEPLOY_PATH}/backend/"
      Write-Host ""
      Write-Host "# 3. ä¸Šä¼ å‰ç«¯ä»£ç " -ForegroundColor Green
      Write-Host "scp -r front/* ${SERVER_USER}@${SERVER_IP}:${DEPLOY_PATH}/frontend/"
      Write-Host ""
      Write-Host "# 4. å®‰è£…åç«¯ä¾èµ–" -ForegroundColor Green
      Write-Host "ssh ${SERVER_USER}@${SERVER_IP} 'cd ${DEPLOY_PATH}/backend && npm install --production'"
      Write-Host ""
      Write-Host "# 5. é‡å¯æœåŠ¡" -ForegroundColor Green
      Write-Host "ssh ${SERVER_USER}@${SERVER_IP} 'cd ${DEPLOY_PATH}/backend && pm2 restart all'"
      Write-Host ""
      Write-Host "# 6. æ£€æŸ¥çŠ¶æ€" -ForegroundColor Green
      Write-Host "ssh ${SERVER_USER}@${SERVER_IP} 'pm2 list'"
      Write-Host ""
      Write-Host "================================="
      Write-Host "âœ… è¿é€šæ€§æµ‹è¯•å®Œæˆï¼Œå¯ä»¥éƒ¨ç½²ï¼"
      Write-Host "ğŸŒ è®¿é—®åœ°å€: http://${SERVER_IP}"
  tags:
    - local
  only:
    - main
  when: manual