# .gitlab-ci.yml
stages:
  - validate
  - build
  - test
  - deploy

# é˜¶æ®µ1: ä»£ç éªŒè¯
validate-code:
  stage: validate
  script:
    - echo "ğŸ” å¼€å§‹ä»£ç è¯­æ³•æ£€æŸ¥..."
    - echo "================================="
    - |
      # æ£€æŸ¥åç«¯ç›®å½•æ˜¯å¦å­˜åœ¨
      if (Test-Path "back") {
        Write-Host "æ£€æŸ¥åç«¯ä»£ç  (back/)..."
        cd back
        $jsFiles = Get-ChildItem -Recurse -Filter *.js
        Write-Host "æ‰¾åˆ°JavaScriptæ–‡ä»¶: $($jsFiles.Count)"
        
        # æ£€æŸ¥è¯­æ³•é”™è¯¯
        Write-Host "æ£€æŸ¥è¯­æ³•é”™è¯¯..."
        $errorCount = 0
        foreach ($file in $jsFiles) {
          if (node -c $file.FullName 2>$null) {
            Write-Host "  âœ… $($file.Name) - è¯­æ³•æ­£ç¡®"
          } else {
            Write-Host "  âŒ $($file.Name) - è¯­æ³•é”™è¯¯"
            $errorCount++
          }
        }
        
        if ($errorCount -eq 0) {
          Write-Host "âœ… åç«¯ä»£ç è¯­æ³•æ£€æŸ¥é€šè¿‡"
        } else {
          Write-Host "âš ï¸  å‘ç° $errorCount ä¸ªè¯­æ³•é”™è¯¯"
        }
        cd ..
      } else {
        Write-Host "âš ï¸  åç«¯ç›®å½•ä¸å­˜åœ¨"
      }
    - echo "================================="
  tags:
    - local
  only:
    - main
  allow_failure: false

# é˜¶æ®µ2: æ„å»º
build-job:
  stage: build
  script:
    - echo "ç¼–è¯‘ä»£ç ..."
    - echo "ç¼–è¯‘å®Œæˆã€‚"
    - |
     if (Test-Path "back") {
        Write-Host "å®‰è£…åç«¯ä¾èµ–..."
        cd back
        npm install
        cd ..
        Write-Host "âœ… åç«¯ä¾èµ–å®‰è£…å®Œæˆ"
      }
     # 2. æ„å»ºå‰ç«¯ï¼ˆå¦‚æœæœ‰ï¼‰
    - |
      if (Test-Path "front") {
        Write-Host "æ„å»ºå‰ç«¯..."
        cd front
        npm install
        npm run build
        cd ..
        Write-Host "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
      }
  tags:
    - local
  only:
    - main

# é˜¶æ®µ3: æµ‹è¯•
unit-test-job:
  stage: test
  script:
    - echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
    - echo "æµ‹è¯•å®Œæˆã€‚"
  tags:
    - local
  only:
    - main
  allow_failure: true

# é˜¶æ®µ4: éƒ¨ç½²
# é˜¶é˜¶æ®µ4: ç®€å•çš„çœŸå®éƒ¨ç½²
deploy-simple:
  stage: deploy
  script:
    - |
      Write-Host "ğŸš€ çœŸå®éƒ¨ç½² - æ‰‹åŠ¨æ“ä½œæŒ‡å—" -ForegroundColor Cyan
      Write-Host "================================="
      Write-Host ""
      Write-Host "ğŸ“ ç›®å½•æ˜ å°„:" -ForegroundColor Yellow
      Write-Host "   æœ¬åœ° back/  â†’ æœåŠ¡å™¨ ${SERVER_USER}@${SERVER_IP}:${DEPLOY_PATH}/backend/"
      Write-Host "   æœ¬åœ° front/ â†’ æœåŠ¡å™¨ ${SERVER_USER}@${SERVER_IP}:${DEPLOY_PATH}/frontend/"
      Write-Host ""
      Write-Host "ğŸ”§ éƒ¨ç½²å‘½ä»¤:" -ForegroundColor Yellow
      Write-Host ""
      Write-Host "# 1. å¤åˆ¶æ–‡ä»¶åˆ°æœåŠ¡å™¨" -ForegroundColor Green
      Write-Host "scp -r back/* ${SERVER_USER}@${SERVER_IP}:${DEPLOY_PATH}/backend/"
      Write-Host "scp -r front/* ${SERVER_USER}@${SERVER_IP}:${DEPLOY_PATH}/frontend/"
      Write-Host ""
      Write-Host "# 2. å®‰è£…åç«¯ä¾èµ–" -ForegroundColor Green
      Write-Host "ssh ${SERVER_USER}@${SERVER_IP} 'cd ${DEPLOY_PATH}/backend && npm install --production'"
      Write-Host ""
      Write-Host "# 3. é‡å¯æœåŠ¡" -ForegroundColor Green
      Write-Host "ssh ${SERVER_USER}@${SERVER_IP} 'cd ${DEPLOY_PATH}/backend && pm2 restart all'"
      Write-Host ""
      Write-Host "# 4. æ£€æŸ¥çŠ¶æ€" -ForegroundColor Green
      Write-Host "ssh ${SERVER_USER}@${SERVER_IP} 'pm2 list'"
      Write-Host ""
      Write-Host "================================="
      Write-Host "âœ… æŒ‰ç…§ä»¥ä¸Šå‘½ä»¤æ‰§è¡Œå³å¯å®Œæˆéƒ¨ç½²"
      Write-Host "ğŸŒ è®¿é—®åœ°å€: http://${SERVER_IP}"
  tags:
    - local
  only:
    - main
  when: manual