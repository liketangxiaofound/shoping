# .gitlab-ci.yml
stages:
  - validate
  - build
  - test
  - deploy

# é˜¶æ®µ1: ä»£ç éªŒè¯
validate-code:
  stage: validate
  script:
    - echo "ğŸ” å¼€å§‹ä»£ç è¯­æ³•æ£€æŸ¥..."
    - echo "================================="
    - |
      # æ£€æŸ¥åç«¯ç›®å½•æ˜¯å¦å­˜åœ¨
      if (Test-Path "back") {
        Write-Host "æ£€æŸ¥åç«¯ä»£ç  (back/)..."
        cd back
        $jsFiles = Get-ChildItem -Recurse -Filter *.js
        Write-Host "æ‰¾åˆ°JavaScriptæ–‡ä»¶: $($jsFiles.Count)"
        
        # æ£€æŸ¥è¯­æ³•é”™è¯¯
        Write-Host "æ£€æŸ¥è¯­æ³•é”™è¯¯..."
        $errorCount = 0
        foreach ($file in $jsFiles) {
          if (node -c $file.FullName 2>$null) {
            Write-Host "  âœ… $($file.Name) - è¯­æ³•æ­£ç¡®"
          } else {
            Write-Host "  âŒ $($file.Name) - è¯­æ³•é”™è¯¯"
            $errorCount++
          }
        }
        
        if ($errorCount -eq 0) {
          Write-Host "âœ… åç«¯ä»£ç è¯­æ³•æ£€æŸ¥é€šè¿‡"
        } else {
          Write-Host "âš ï¸  å‘ç° $errorCount ä¸ªè¯­æ³•é”™è¯¯"
        }
        cd ..
      } else {
        Write-Host "âš ï¸  åç«¯ç›®å½•ä¸å­˜åœ¨"
      }
    - echo "================================="
  tags:
    - local
  only:
    - main
  allow_failure: false

# é˜¶æ®µ2: æ„å»º
build-job:
  stage: build
  script:
    - echo "ç¼–è¯‘ä»£ç ..."
    - echo "ç¼–è¯‘å®Œæˆã€‚"
    - |
     if (Test-Path "back") {
        Write-Host "å®‰è£…åç«¯ä¾èµ–..."
        cd back
        npm install
        cd ..
        Write-Host "âœ… åç«¯ä¾èµ–å®‰è£…å®Œæˆ"
      }
     # 2. æ„å»ºå‰ç«¯ï¼ˆå¦‚æœæœ‰ï¼‰
    - |
      if (Test-Path "front") {
        Write-Host "æ„å»ºå‰ç«¯..."
        cd front
        npm install
        npm run build
        cd ..
        Write-Host "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
      }
  tags:
    - local
  only:
    - main

# é˜¶æ®µ3: æµ‹è¯•
unit-test-job:
  stage: test
  script:
    - echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
    - echo "æµ‹è¯•å®Œæˆã€‚"
  tags:
    - local
  only:
    - main
  allow_failure: true

# é˜¶æ®µ4: åŠè‡ªåŠ¨éƒ¨ç½²ï¼ˆéœ€è¦SSHé…ç½®ï¼‰
deploy-semi-auto:
  stage: deploy
  before_script:
    - |
      Write-Host "ğŸ› ï¸ é…ç½® SSH ç¯å¢ƒ..." -ForegroundColor Cyan
      
      $sshDir = "$env:USERPROFILE\.ssh"
      if (-not (Test-Path $sshDir)) {
        New-Item -ItemType Directory -Path $sshDir | Out-Null
      }
      
      # è®¾ç½® .ssh ç›®å½•æƒé™ï¼ˆä»…å½“å‰ç”¨æˆ·ï¼‰
      icacls $sshDir /inheritance:r /grant:r "$env:USERNAME:(F)" | Out-Null
      
      # æ£€æŸ¥ SSH_PRIVATE_KEY
      if ($env:SSH_PRIVATE_KEY) {
        Write-Host "âœ… æ‰¾åˆ° SSH_PRIVATE_KEY å˜é‡"
        $keyFile = "$sshDir\id_rsa"
        Set-Content -Path $keyFile -Value $env:SSH_PRIVATE_KEY -NoNewline
        
        # è®¾ç½®ç§é’¥æƒé™ï¼ˆä»…å½“å‰ç”¨æˆ·è¯»å†™ï¼‰
        icacls $keyFile /inheritance:r /grant:r "$env:USERNAME:(R,W)" | Out-Null
        Write-Host "âœ… SSH ç§é’¥å·²é…ç½®"
      } else {
        Write-Host "âš ï¸ æœªè®¾ç½® SSH_PRIVATE_KEY å˜é‡" -ForegroundColor Yellow
        Write-Host "è¯·åœ¨ GitLab CI/CD Variables ä¸­æ·»åŠ  SSH_PRIVATE_KEYï¼ˆç±»å‹ä¸º Variableï¼‰"
        exit 1
      }
      
      # æµ‹è¯•æœåŠ¡å™¨è¿é€šæ€§
      Write-Host "ğŸ”Œ æµ‹è¯•æœåŠ¡å™¨è¿é€šæ€§..."
      if (Test-Connection -ComputerName $env:SERVER_IP -Count 1 -Quiet -ErrorAction SilentlyContinue) {
        Write-Host "âœ… æœåŠ¡å™¨å¯ä»¥è¿é€š"
      } else {
        Write-Host "âŒ æ— æ³• ping é€šæœåŠ¡å™¨: $($env:SERVER_IP)" -ForegroundColor Red
        exit 1
      }
  script:
    - |
      Write-Host "ğŸš€ åŠè‡ªåŠ¨éƒ¨ç½²åˆ°é˜¿é‡Œäº‘" -ForegroundColor Cyan
      Write-Host "================================="
      
      $server = $env:SERVER_IP
      $user = $env:SERVER_USER
      $deployPath = $env:DEPLOY_PATH
      $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
      $sshKeyPath = "$env:USERPROFILE\.ssh\id_rsa"
      
      # å‚æ•°æ ¡éªŒ
      if ([string]::IsNullOrWhiteSpace($server) -or [string]::IsNullOrWhiteSpace($user) -or [string]::IsNullOrWhiteSpace($deployPath)) {
        Write-Host "âŒ ç¼ºå°‘å¿…è¦çš„ç¯å¢ƒå˜é‡: SERVER_IP, SERVER_USER, DEPLOY_PATH" -ForegroundColor Red
        exit 1
      }
      
      Write-Host "æœåŠ¡å™¨: ${user}@${server}"
      Write-Host "è·¯å¾„: ${deployPath}"
      Write-Host "æ—¶é—´æˆ³: ${timestamp}"
      Write-Host ""
      
      if (Test-Path $sshKeyPath) {
        Write-Host "ğŸ” æ£€æµ‹åˆ° SSH å¯†é’¥ï¼Œå¼€å§‹è‡ªåŠ¨éƒ¨ç½²..." -ForegroundColor Green
        Write-Host "ğŸ’¡ æ‰‹åŠ¨ä½œä¸šå·²è§¦å‘ï¼Œè‡ªåŠ¨ç»§ç»­éƒ¨ç½²..." -ForegroundColor Green
        
        # 1. å¤‡ä»½
        Write-Host "`n1. å¤‡ä»½ç°æœ‰ä»£ç ..." -ForegroundColor Yellow
        ssh -i "$sshKeyPath" -o StrictHostKeyChecking=no -o UserKnownHostsFile=NUL "${user}@${server}" "cd '${deployPath}' && tar -czf backup_${timestamp}.tar.gz backend frontend 2>/dev/null || echo 'é¦–æ¬¡éƒ¨ç½²ï¼Œè·³è¿‡å¤‡ä»½'"
        
        # 2. ä¸Šä¼ åç«¯
        if (Test-Path "back") {
          Write-Host "`n2. ä¸Šä¼ åç«¯ä»£ç ..." -ForegroundColor Yellow
          scp -i "$sshKeyPath" -r -o StrictHostKeyChecking=no -o UserKnownHostsFile=NUL back/* "${user}@${server}:${deployPath}/backend/"
          Write-Host "âœ… åç«¯ä¸Šä¼ å®Œæˆ" -ForegroundColor Green
        }
        
        # 3. ä¸Šä¼ å‰ç«¯
        if (Test-Path "front") {
          Write-Host "`n3. ä¸Šä¼ å‰ç«¯ä»£ç ..." -ForegroundColor Yellow
          scp -i "$sshKeyPath" -r -o StrictHostKeyChecking=no -o UserKnownHostsFile=NUL front/* "${user}@${server}:${deployPath}/frontend/"
          Write-Host "âœ… å‰ç«¯ä¸Šä¼ å®Œæˆ" -ForegroundColor Green
        }
        
        # 4. å®‰è£…ä¾èµ–å¹¶é‡å¯æœåŠ¡
        Write-Host "`n4. å®‰è£…ä¾èµ–å¹¶é‡å¯æœåŠ¡..." -ForegroundColor Yellow
        ssh -i "$sshKeyPath" -o StrictHostKeyChecking=no -o UserKnownHostsFile=NUL "${user}@${server}" "cd '${deployPath}/backend' && npm install --production && pm2 restart all"
        
        Write-Host "`nâœ… éƒ¨ç½²å®Œæˆï¼" -ForegroundColor Green
        Write-Host "ğŸŒ è®¿é—®åœ°å€: http://${server}"
        
      } else {
        Write-Host "âŒ æœªæ£€æµ‹åˆ° SSH ç§é’¥ï¼Œä»…æ˜¾ç¤ºæ‰‹åŠ¨å‘½ä»¤" -ForegroundColor Red
        Write-Host "`nğŸ”§ æ‰‹åŠ¨éƒ¨ç½²å‘½ä»¤ï¼š" -ForegroundColor Cyan
        Write-Host "================================="
        Write-Host "# å¤‡ä»½"
        Write-Host "ssh -i ~/.ssh/id_rsa ${user}@${server} 'cd ${deployPath} && tar -czf backup_${timestamp}.tar.gz backend frontend'"
        Write-Host ""
        Write-Host "# ä¸Šä¼ åç«¯"
        Write-Host "scp -i ~/.ssh/id_rsa -r back/* ${user}@${server}:${deployPath}/backend/"
        Write-Host ""
        Write-Host "# ä¸Šä¼ å‰ç«¯"
        Write-Host "scp -i ~/.ssh/id_rsa -r front/* ${user}@${server}:${deployPath}/frontend/"
        Write-Host ""
        Write-Host "# å®‰è£…ä¾èµ–å¹¶é‡å¯"
        Write-Host "ssh -i ~/.ssh/id_rsa ${user}@${server} 'cd ${deployPath}/backend && npm install --production && pm2 restart all'"
        Write-Host "================================="
      }
  tags:
    - local
  only:
    - main
  when: manual


# é˜¶æ®µ5: å…¨è‡ªåŠ¨éƒ¨ç½²ï¼ˆæ¨é€æ—¶è‡ªåŠ¨è§¦å‘ï¼‰
deploy-auto:
  stage: deploy
  before_script:
    - |
      Write-Host "ğŸš€ å…¨è‡ªåŠ¨éƒ¨ç½²åˆå§‹åŒ–..." -ForegroundColor Cyan
      
      # è°ƒè¯•ï¼šæ£€æŸ¥ç§é’¥å¼€å¤´ï¼ˆç¡®ä¿æ˜¯å†…å®¹ï¼Œä¸æ˜¯è·¯å¾„ï¼‰
      if ($env:SSH_PRIVATE_KEY) {
        $preview = if ($env:SSH_PRIVATE_KEY.Length -gt 50) { $env:SSH_PRIVATE_KEY.Substring(0, 50) } else { $env:SSH_PRIVATE_KEY }
        Write-Host "DEBUG: ç§é’¥å‰50å­—ç¬¦: $preview" -ForegroundColor Magenta
      }
      
      # ä½¿ç”¨ç³»ç»Ÿ TEMP ç›®å½•ï¼ˆé¿å…ä¸­æ–‡ç”¨æˆ·åæˆ–æƒé™é—®é¢˜ï¼‰
      $sshKeyPath = "$env:TEMP\gitlab_deploy_key"
      
      # æ£€æŸ¥å¿…è¦ç¯å¢ƒå˜é‡
      if ([string]::IsNullOrWhiteSpace($env:SERVER_IP) -or 
          [string]::IsNullOrWhiteSpace($env:SERVER_USER) -or 
          [string]::IsNullOrWhiteSpace($env:DEPLOY_PATH) -or 
          [string]::IsNullOrWhiteSpace($env:SSH_PRIVATE_KEY)) {
        Write-Host "âŒ ç¼ºå°‘å¿…è¦çš„ç¯å¢ƒå˜é‡" -ForegroundColor Red
        Write-Host "è¯·ç¡®ä¿è®¾ç½®äº†: SERVER_IP, SERVER_USER, DEPLOY_PATH, SSH_PRIVATE_KEY" -ForegroundColor Yellow
        exit 1
      }
      
      # âœ… å…³é”®ä¿®å¤ï¼šä»¥ UTF-8 æ—  BOM å†™å…¥ç§é’¥ï¼ˆè§£å†³ OpenSSH æ— æ³•è¯»å–é—®é¢˜ï¼‰
      Write-Host "é…ç½® SSH ç§é’¥åˆ°ä¸´æ—¶è·¯å¾„: $sshKeyPath" -ForegroundColor Yellow
      $bytes = [System.Text.Encoding]::UTF8.GetBytes($env:SSH_PRIVATE_KEY)
      [System.IO.File]::WriteAllBytes($sshKeyPath, $bytes)
      # è®¾ç½®éšè— + åªè¯»ï¼ˆå¢å¼ºå®‰å…¨æ€§ï¼‰
      attrib +h +r $sshKeyPath 2>$null | Out-Null
      Write-Host "âœ… SSH ç§é’¥å·²ä¿å­˜ï¼ˆUTF-8 æ—  BOMï¼‰" -ForegroundColor Green
      
      # éªŒè¯ç§é’¥æ ¼å¼ï¼ˆä½¿ç”¨ UTF8 ç¼–ç è¯»å–ï¼‰
      $firstLine = Get-Content -Path $sshKeyPath -First 1 -Encoding UTF8
      if ($firstLine -notmatch "-----BEGIN") {
        Write-Host "âš ï¸  SSH å¯†é’¥æ ¼å¼å¯èƒ½æœ‰é—®é¢˜" -ForegroundColor Yellow
        Write-Host "ç¬¬ä¸€è¡Œ: $firstLine" -ForegroundColor Gray
      }
      
      # æµ‹è¯•æœåŠ¡å™¨è¿é€šæ€§
      Write-Host "æµ‹è¯•æœåŠ¡å™¨è¿é€šæ€§..." -ForegroundColor Yellow
      $pingSuccess = $false
      $maxPingAttempts = 3
      for ($i = 1; $i -le $maxPingAttempts; $i++) {
        Write-Host "å°è¯• $i/$maxPingAttempts..."
        if (Test-Connection -ComputerName $env:SERVER_IP -Count 1 -Quiet -ErrorAction SilentlyContinue) {
          $pingSuccess = $true
          Write-Host "âœ… æœåŠ¡å™¨å¯ä»¥è¿é€š" -ForegroundColor Green
          break
        }
        Start-Sleep -Seconds 2
      }
      if (-not $pingSuccess) {
        Write-Host "âŒ æ— æ³•è¿æ¥æœåŠ¡å™¨: $($env:SERVER_IP)" -ForegroundColor Red
        exit 1
      }
      
      # æµ‹è¯• SSH è¿æ¥
      Write-Host "æµ‹è¯• SSH è¿æ¥..." -ForegroundColor Yellow
      # æ³¨æ„ï¼šè·¯å¾„ç”¨åŒå¼•å·åŒ…è£¹ï¼Œé˜²æ­¢ç©ºæ ¼ï¼ˆè™½ç„¶ TEMP é€šå¸¸æ— ç©ºæ ¼ï¼‰
      $sshTestCmd = "ssh -i `"$sshKeyPath`" -o ConnectTimeout=10 -o BatchMode=yes -o StrictHostKeyChecking=no `"$($env:SERVER_USER)@$($env:SERVER_IP)`" `"echo SSH_CONNECT_TEST_OK && exit 0`""
      $sshOutput = cmd /c "$sshTestCmd"
      if ($sshOutput -match "SSH_CONNECT_TEST_OK") {
        Write-Host "âœ… SSH è¿æ¥æµ‹è¯•æˆåŠŸ" -ForegroundColor Green
        # å°†è·¯å¾„å­˜å…¥ç¯å¢ƒå˜é‡ä¾› script ä½¿ç”¨
        [System.Environment]::SetEnvironmentVariable("GITLAB_SSH_KEY_PATH", $sshKeyPath)
      } else {
        Write-Host "âŒ SSH è¿æ¥æµ‹è¯•å¤±è´¥" -ForegroundColor Red
        Write-Host "è¾“å‡º: $sshOutput" -ForegroundColor Gray
        exit 1
      }
  
  script:
    - |
      Write-Host "ğŸ¯ å¼€å§‹å…¨è‡ªåŠ¨éƒ¨ç½²..." -ForegroundColor Green
      Write-Host "================================="
      
      $server = $env:SERVER_IP
      $user = $env:SERVER_USER
      $deployPath = $env:DEPLOY_PATH
      $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
      # ä»ç¯å¢ƒå˜é‡è·å–å¯†é’¥è·¯å¾„
      $sshKeyPath = $env:GITLAB_SSH_KEY_PATH
      
      if (-not $sshKeyPath -or -not (Test-Path $sshKeyPath)) {
        Write-Host "âŒ SSH å¯†é’¥è·¯å¾„æœªè®¾ç½®æˆ–æ–‡ä»¶ä¸å­˜åœ¨" -ForegroundColor Red
        exit 1
      }
      
      Write-Host "éƒ¨ç½²ä¿¡æ¯:" -ForegroundColor Cyan
      Write-Host "  - æœåŠ¡å™¨: ${user}@${server}"
      Write-Host "  - éƒ¨ç½²è·¯å¾„: ${deployPath}"
      Write-Host "  - æ—¶é—´æˆ³: ${timestamp}"
      Write-Host "  - æäº¤: $env:CI_COMMIT_SHORT_SHA"
      Write-Host "  - åˆ†æ”¯: $env:CI_COMMIT_REF_NAME"
      Write-Host ""
      
      # 1. å¤‡ä»½æœåŠ¡å™¨ä»£ç 
      Write-Host "1ï¸âƒ£ å¤‡ä»½æœåŠ¡å™¨ç°æœ‰ä»£ç ..." -ForegroundColor Yellow
      $backupCmd = "cd '${deployPath}' && tar -czf backup_${timestamp}.tar.gz backend frontend 2>/dev/null || echo 'é¦–æ¬¡éƒ¨ç½²ï¼Œæ— éœ€å¤‡ä»½'"
      $backupResult = cmd /c "ssh -i `"$sshKeyPath`" -o BatchMode=yes -o StrictHostKeyChecking=no `${user}@${server}` `$backupCmd`"
      Write-Host "å¤‡ä»½ç»“æœ: $backupResult" -ForegroundColor Gray
      Write-Host "âœ… å¤‡ä»½å®Œæˆ" -ForegroundColor Green
      
      # 2. ä¸Šä¼ åç«¯ä»£ç 
      if (Test-Path "back") {
        Write-Host "`n2ï¸âƒ£ ä¸Šä¼ åç«¯ä»£ç ..." -ForegroundColor Yellow
        $backFileCount = (Get-ChildItem -Recurse -Path "back" | Measure-Object).Count
        Write-Host "å‘ç° $backFileCount ä¸ªæ–‡ä»¶éœ€è¦ä¸Šä¼ " -ForegroundColor Gray
        
        $mkdirBackend = "mkdir -p '${deployPath}/backend'"
        cmd /c "ssh -i `"$sshKeyPath`" -o BatchMode=yes `${user}@${server}` `$mkdirBackend`" | Out-Null
        
        $uploadBackResult = cmd /c "scp -i `"$sshKeyPath`" -r -o BatchMode=yes back/* `${user}@${server}:${deployPath}/backend/`"
        if ($LASTEXITCODE -eq 0) {
          Write-Host "âœ… åç«¯ä»£ç ä¸Šä¼ å®Œæˆ" -ForegroundColor Green
        } else {
          Write-Host "âŒ åç«¯ä»£ç ä¸Šä¼ å¤±è´¥: $uploadBackResult" -ForegroundColor Red
        }
      } else {
        Write-Host "âš ï¸  backç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡åç«¯éƒ¨ç½²" -ForegroundColor Yellow
      }
      
      # 3. ä¸Šä¼ å‰ç«¯ä»£ç 
      if (Test-Path "front") {
        Write-Host "`n3ï¸âƒ£ ä¸Šä¼ å‰ç«¯ä»£ç ..." -ForegroundColor Yellow
        $frontFileCount = (Get-ChildItem -Recurse -Path "front" | Measure-Object).Count
        Write-Host "å‘ç° $frontFileCount ä¸ªæ–‡ä»¶éœ€è¦ä¸Šä¼ " -ForegroundColor Gray
        
        $mkdirFrontend = "mkdir -p '${deployPath}/frontend'"
        cmd /c "ssh -i `"$sshKeyPath`" -o BatchMode=yes `${user}@${server}` `$mkdirFrontend`" | Out-Null
        
        $uploadFrontResult = cmd /c "scp -i `"$sshKeyPath`" -r -o BatchMode=yes front/* `${user}@${server}:${deployPath}/frontend/`"
        if ($LASTEXITCODE -eq 0) {
          Write-Host "âœ… å‰ç«¯ä»£ç ä¸Šä¼ å®Œæˆ" -ForegroundColor Green
        } else {
          Write-Host "âŒ å‰ç«¯ä»£ç ä¸Šä¼ å¤±è´¥: $uploadFrontResult" -ForegroundColor Red
        }
      } else {
        Write-Host "âš ï¸  frontç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡å‰ç«¯éƒ¨ç½²" -ForegroundColor Yellow
      }
      
      # 4. å®‰è£…ä¾èµ–
      Write-Host "`n4ï¸âƒ£ å®‰è£…åç«¯ä¾èµ–..." -ForegroundColor Yellow
      $installCmd = "cd '${deployPath}/backend' && npm install --production"
      $installResult = cmd /c "ssh -i `"$sshKeyPath`" -o BatchMode=yes `${user}@${server}` `$installCmd`"
      if ($LASTEXITCODE -eq 0) {
        Write-Host "âœ… ä¾èµ–å®‰è£…å®Œæˆ" -ForegroundColor Green
      } else {
        Write-Host "âŒ ä¾èµ–å®‰è£…å¤±è´¥: $installResult" -ForegroundColor Red
      }
      
      # 5. é‡å¯æœåŠ¡
      Write-Host "`n5ï¸âƒ£ é‡å¯ PM2 æœåŠ¡..." -ForegroundColor Yellow
      $restartCmd = "cd '${deployPath}/backend' && pm2 restart all"
      $restartResult = cmd /c "ssh -i `"$sshKeyPath`" -o BatchMode=yes `${user}@${server}` `$restartCmd`"
      if ($LASTEXITCODE -eq 0) {
        Write-Host "âœ… æœåŠ¡é‡å¯æˆåŠŸ" -ForegroundColor Green
      } else {
        Write-Host "âš ï¸  PM2é‡å¯å¤±è´¥ï¼Œå°è¯•å¯åŠ¨æ–°è¿›ç¨‹..." -ForegroundColor Yellow
        $startCmd = "cd '${deployPath}/backend' && pm2 start npm --name 'backend' -- run start"
        $startResult = cmd /c "ssh -i `"$sshKeyPath`" -o BatchMode=yes `${user}@${server}` `$startCmd`"
        Write-Host "å¯åŠ¨ç»“æœ: $startResult" -ForegroundColor Gray
      }
      
      # 6. å¥åº·æ£€æŸ¥
      Write-Host "`n6ï¸âƒ£ å¥åº·æ£€æŸ¥..." -ForegroundColor Yellow
      Start-Sleep -Seconds 5
      $healthCheck = @"
        echo "æ£€æŸ¥ Node.js è¿›ç¨‹:"
        ps aux | grep node | grep -v grep
        echo ""
        echo "æ£€æŸ¥ PM2 çŠ¶æ€:"
        pm2 list
        echo ""
        echo "æ£€æŸ¥ç«¯å£ 3000:"
        netstat -tlnp | grep :3000 || echo "ç«¯å£ 3000 æœªç›‘å¬"
      "@
      $healthResult = cmd /c "ssh -i `"$sshKeyPath`" -o BatchMode=yes `${user}@${server}` `$healthCheck`"
      Write-Host "å¥åº·æ£€æŸ¥ç»“æœ:" -ForegroundColor Cyan
      $healthResult
      
      Write-Host "`nğŸ‰ å…¨è‡ªåŠ¨éƒ¨ç½²å®Œæˆï¼" -ForegroundColor Green
      Write-Host "================================="
      Write-Host "ğŸŒ ç½‘ç«™åœ°å€: http://${server}:3000"
      Write-Host "ğŸ“… éƒ¨ç½²æ—¶é—´: $(Get-Date)"
      Write-Host "ğŸ”§ æäº¤å“ˆå¸Œ: $env:CI_COMMIT_SHORT_SHA"
      Write-Host "ğŸŒ¿ åˆ†æ”¯: $env:CI_COMMIT_REF_NAME"
      Write-Host "================================="
      
      Write-Host "`nğŸ“¢ éƒ¨ç½²å®Œæˆé€šçŸ¥å·²å‘é€" -ForegroundColor Gray
  
  after_script:
    - |
      Write-Host "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..." -ForegroundColor Gray
      $sshKeyPath = "$env:TEMP\gitlab_deploy_key"
      if (Test-Path $sshKeyPath) {
        # å…ˆå–æ¶ˆåªè¯»å±æ€§å†åˆ é™¤
        attrib -r $sshKeyPath 2>$null | Out-Null
        Remove-Item $sshKeyPath -Force -ErrorAction SilentlyContinue
        Write-Host "âœ… å·²æ¸…ç† SSH ç§é’¥" -ForegroundColor Green
      }
  
  tags:
    - local
  only:
    - main
  when: on_success
  environment:
    name: production
    url: http://$SERVER_IP:3000