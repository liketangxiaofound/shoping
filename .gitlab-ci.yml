# .gitlab-ci.yml
stages:
  - validate
  - build
  - test
  - deploy

# é˜¶æ®µ1: ä»£ç éªŒè¯
validate-code:
  stage: validate
  script:
    - echo "ğŸ” å¼€å§‹ä»£ç è¯­æ³•æ£€æŸ¥..."
    - echo "================================="
    - |
      # æ£€æŸ¥åç«¯ç›®å½•æ˜¯å¦å­˜åœ¨
      if (Test-Path "back") {
        Write-Host "æ£€æŸ¥åç«¯ä»£ç  (back/)..."
        cd back
        $jsFiles = Get-ChildItem -Recurse -Filter *.js
        Write-Host "æ‰¾åˆ°JavaScriptæ–‡ä»¶: $($jsFiles.Count)"
        
        # æ£€æŸ¥è¯­æ³•é”™è¯¯
        Write-Host "æ£€æŸ¥è¯­æ³•é”™è¯¯..."
        $errorCount = 0
        foreach ($file in $jsFiles) {
          if (node -c $file.FullName 2>$null) {
            Write-Host "  âœ… $($file.Name) - è¯­æ³•æ­£ç¡®"
          } else {
            Write-Host "  âŒ $($file.Name) - è¯­æ³•é”™è¯¯"
            $errorCount++
          }
        }
        
        if ($errorCount -eq 0) {
          Write-Host "âœ… åç«¯ä»£ç è¯­æ³•æ£€æŸ¥é€šè¿‡"
        } else {
          Write-Host "âš ï¸  å‘ç° $errorCount ä¸ªè¯­æ³•é”™è¯¯"
        }
        cd ..
      } else {
        Write-Host "âš ï¸  åç«¯ç›®å½•ä¸å­˜åœ¨"
      }
    - echo "================================="
  tags:
    - local
  only:
    - main
  allow_failure: false

# é˜¶æ®µ2: æ„å»º
build-job:
  stage: build
  script:
    - echo "ç¼–è¯‘ä»£ç ..."
    - echo "ç¼–è¯‘å®Œæˆã€‚"
    - |
     if (Test-Path "back") {
        Write-Host "å®‰è£…åç«¯ä¾èµ–..."
        cd back
        npm install
        cd ..
        Write-Host "âœ… åç«¯ä¾èµ–å®‰è£…å®Œæˆ"
      }
     # 2. æ„å»ºå‰ç«¯ï¼ˆå¦‚æœæœ‰ï¼‰
    - |
      if (Test-Path "front") {
        Write-Host "æ„å»ºå‰ç«¯..."
        cd front
        npm install
        npm run build
        cd ..
        Write-Host "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
      }
  tags:
    - local
  only:
    - main

# é˜¶æ®µ3: æµ‹è¯•
unit-test-job:
  stage: test
  script:
    - echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
    - echo "æµ‹è¯•å®Œæˆã€‚"
  tags:
    - local
  only:
    - main
  allow_failure: true

# é˜¶æ®µ4: éƒ¨ç½²
deploy-job:
  stage: deploy
  script:
    - echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨..."
    - echo "================================="
    
    # 1. é…ç½®å˜é‡
    - $server = "8.155.175.119"
    - $user = "linger"
    - $deployPath = "/home/linger/shopping-app"
    - $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
    
    # 2. å‡†å¤‡éƒ¨ç½²åŒ…
    - Write-Host "æ­¥éª¤1: å‡†å¤‡éƒ¨ç½²åŒ…..."
    - Compress-Archive -Path back/* -DestinationPath "deploy-back-$timestamp.zip"
    - Write-Host "âœ… éƒ¨ç½²åŒ…å‡†å¤‡å®Œæˆ"
    
    # 3. å¤‡ä»½å½“å‰ç‰ˆæœ¬
    - Write-Host "æ­¥éª¤2: å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
    - ssh ${user}@${server} "cd $deployPath && tar -czf backup-$timestamp.tar.gz ."
    - Write-Host "âœ… å¤‡ä»½å®Œæˆ"
    
    # 4. ä¸Šä¼ æ–°ç‰ˆæœ¬
    - Write-Host "æ­¥éª¤3: ä¸Šä¼ æ–°ç‰ˆæœ¬..."
    - scp "deploy-back-$timestamp.zip" ${user}@${server}:"${deployPath}/deploy-back-$timestamp.zip"
    
    # 5. éƒ¨ç½²
    - Write-Host "æ­¥éª¤4: éƒ¨ç½²åº”ç”¨..."
    - ssh ${user}@${server} "
        cd $deployPath
        unzip -o deploy-back-$timestamp.zip
        rm deploy-back-$timestamp.zip
        npm install --production
        pm2 restart shopping-app || pm2 start app.js --name shopping-app
      "
    
    # 6. æ¸…ç†
    - Remove-Item "deploy-back-$timestamp.zip"
    
    - echo "================================="
  tags:
    - local
  only:
    - main
  when: manual