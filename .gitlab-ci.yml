# .gitlab-ci.yml
stages:
  - validate
  - build
  - test
  - deploy

# é˜¶æ®µ1: ä»£ç éªŒè¯
validate-code:
  stage: validate
  script:
    - echo "ğŸ” å¼€å§‹ä»£ç è¯­æ³•æ£€æŸ¥..."
    - echo "================================="
    - |
      # æ£€æŸ¥åç«¯ç›®å½•æ˜¯å¦å­˜åœ¨
      if (Test-Path "back") {
        Write-Host "æ£€æŸ¥åç«¯ä»£ç  (back/)..."
        cd back
        $jsFiles = Get-ChildItem -Recurse -Filter *.js
        Write-Host "æ‰¾åˆ°JavaScriptæ–‡ä»¶: $($jsFiles.Count)"
        
        # æ£€æŸ¥è¯­æ³•é”™è¯¯
        Write-Host "æ£€æŸ¥è¯­æ³•é”™è¯¯..."
        $errorCount = 0
        foreach ($file in $jsFiles) {
          if (node -c $file.FullName 2>$null) {
            Write-Host "  âœ… $($file.Name) - è¯­æ³•æ­£ç¡®"
          } else {
            Write-Host "  âŒ $($file.Name) - è¯­æ³•é”™è¯¯"
            $errorCount++
          }
        }
        
        if ($errorCount -eq 0) {
          Write-Host "âœ… åç«¯ä»£ç è¯­æ³•æ£€æŸ¥é€šè¿‡"
        } else {
          Write-Host "âš ï¸  å‘ç° $errorCount ä¸ªè¯­æ³•é”™è¯¯"
        }
        cd ..
      } else {
        Write-Host "âš ï¸  åç«¯ç›®å½•ä¸å­˜åœ¨"
      }
    - echo "================================="
  tags:
    - local
  only:
    - main
  allow_failure: false

# é˜¶æ®µ2: æ„å»º
build-job:
  stage: build
  script:
    - echo "ç¼–è¯‘ä»£ç ..."
    - echo "ç¼–è¯‘å®Œæˆã€‚"
    - |
     if (Test-Path "back") {
        Write-Host "å®‰è£…åç«¯ä¾èµ–..."
        cd back
        npm install
        cd ..
        Write-Host "âœ… åç«¯ä¾èµ–å®‰è£…å®Œæˆ"
      }
     # 2. æ„å»ºå‰ç«¯ï¼ˆå¦‚æœæœ‰ï¼‰
    - |
      if (Test-Path "front") {
        Write-Host "æ„å»ºå‰ç«¯..."
        cd front
        npm install
        npm run build
        cd ..
        Write-Host "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
      }
  tags:
    - local
  only:
    - main

# é˜¶æ®µ3: æµ‹è¯•
unit-test-job:
  stage: test
  script:
    - echo "è¿è¡Œå•å…ƒæµ‹è¯•..."
    - echo "æµ‹è¯•å®Œæˆã€‚"
  tags:
    - local
  only:
    - main
  allow_failure: true

# é˜¶æ®µ4: åŠè‡ªåŠ¨éƒ¨ç½²ï¼ˆéœ€è¦SSHé…ç½®ï¼‰
deploy-semi-auto:
  stage: deploy
  before_script:
    - |
      Write-Host "ğŸ› ï¸ é…ç½® SSH ç¯å¢ƒ..." -ForegroundColor Cyan
      
      $sshDir = "$env:USERPROFILE\.ssh"
      if (-not (Test-Path $sshDir)) {
        New-Item -ItemType Directory -Path $sshDir | Out-Null
      }
      
      # è®¾ç½® .ssh ç›®å½•æƒé™ï¼ˆä»…å½“å‰ç”¨æˆ·ï¼‰
      icacls $sshDir /inheritance:r /grant:r "$env:USERNAME:(F)" | Out-Null
      
      # æ£€æŸ¥ SSH_PRIVATE_KEY
      if ($env:SSH_PRIVATE_KEY) {
        Write-Host "âœ… æ‰¾åˆ° SSH_PRIVATE_KEY å˜é‡"
        $keyFile = "$sshDir\id_rsa"
        Set-Content -Path $keyFile -Value $env:SSH_PRIVATE_KEY -NoNewline
        
        # è®¾ç½®ç§é’¥æƒé™ï¼ˆä»…å½“å‰ç”¨æˆ·è¯»å†™ï¼‰
        icacls $keyFile /inheritance:r /grant:r "$env:USERNAME:(R,W)" | Out-Null
        Write-Host "âœ… SSH ç§é’¥å·²é…ç½®"
      } else {
        Write-Host "âš ï¸ æœªè®¾ç½® SSH_PRIVATE_KEY å˜é‡" -ForegroundColor Yellow
        Write-Host "è¯·åœ¨ GitLab CI/CD Variables ä¸­æ·»åŠ  SSH_PRIVATE_KEYï¼ˆç±»å‹ä¸º Variableï¼‰"
        exit 1
      }
      
      # æµ‹è¯•æœåŠ¡å™¨è¿é€šæ€§
      Write-Host "ğŸ”Œ æµ‹è¯•æœåŠ¡å™¨è¿é€šæ€§..."
      if (Test-Connection -ComputerName $env:SERVER_IP -Count 1 -Quiet -ErrorAction SilentlyContinue) {
        Write-Host "âœ… æœåŠ¡å™¨å¯ä»¥è¿é€š"
      } else {
        Write-Host "âŒ æ— æ³• ping é€šæœåŠ¡å™¨: $($env:SERVER_IP)" -ForegroundColor Red
        exit 1
      }
  script:
    - |
      Write-Host "ğŸš€ åŠè‡ªåŠ¨éƒ¨ç½²åˆ°é˜¿é‡Œäº‘" -ForegroundColor Cyan
      Write-Host "================================="
      
      $server = $env:SERVER_IP
      $user = $env:SERVER_USER
      $deployPath = $env:DEPLOY_PATH
      $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
      $sshKeyPath = "$env:USERPROFILE\.ssh\id_rsa"
      
      # å‚æ•°æ ¡éªŒ
      if ([string]::IsNullOrWhiteSpace($server) -or [string]::IsNullOrWhiteSpace($user) -or [string]::IsNullOrWhiteSpace($deployPath)) {
        Write-Host "âŒ ç¼ºå°‘å¿…è¦çš„ç¯å¢ƒå˜é‡: SERVER_IP, SERVER_USER, DEPLOY_PATH" -ForegroundColor Red
        exit 1
      }
      
      Write-Host "æœåŠ¡å™¨: ${user}@${server}"
      Write-Host "è·¯å¾„: ${deployPath}"
      Write-Host "æ—¶é—´æˆ³: ${timestamp}"
      Write-Host ""
      
      if (Test-Path $sshKeyPath) {
        Write-Host "ğŸ” æ£€æµ‹åˆ° SSH å¯†é’¥ï¼Œå¼€å§‹è‡ªåŠ¨éƒ¨ç½²..." -ForegroundColor Green
        Write-Host "ğŸ’¡ æ‰‹åŠ¨ä½œä¸šå·²è§¦å‘ï¼Œè‡ªåŠ¨ç»§ç»­éƒ¨ç½²..." -ForegroundColor Green
        
        # 1. å¤‡ä»½
        Write-Host "`n1. å¤‡ä»½ç°æœ‰ä»£ç ..." -ForegroundColor Yellow
        ssh -i "$sshKeyPath" -o StrictHostKeyChecking=no -o UserKnownHostsFile=NUL "${user}@${server}" "cd '${deployPath}' && tar -czf backup_${timestamp}.tar.gz backend frontend 2>/dev/null || echo 'é¦–æ¬¡éƒ¨ç½²ï¼Œè·³è¿‡å¤‡ä»½'"
        
        # 2. ä¸Šä¼ åç«¯
        if (Test-Path "back") {
          Write-Host "`n2. ä¸Šä¼ åç«¯ä»£ç ..." -ForegroundColor Yellow
          scp -i "$sshKeyPath" -r -o StrictHostKeyChecking=no -o UserKnownHostsFile=NUL back/* "${user}@${server}:${deployPath}/backend/"
          Write-Host "âœ… åç«¯ä¸Šä¼ å®Œæˆ" -ForegroundColor Green
        }
        
        # 3. ä¸Šä¼ å‰ç«¯
        if (Test-Path "front") {
          Write-Host "`n3. ä¸Šä¼ å‰ç«¯ä»£ç ..." -ForegroundColor Yellow
          scp -i "$sshKeyPath" -r -o StrictHostKeyChecking=no -o UserKnownHostsFile=NUL front/* "${user}@${server}:${deployPath}/frontend/"
          Write-Host "âœ… å‰ç«¯ä¸Šä¼ å®Œæˆ" -ForegroundColor Green
        }
        
        # 4. å®‰è£…ä¾èµ–å¹¶é‡å¯æœåŠ¡
        Write-Host "`n4. å®‰è£…ä¾èµ–å¹¶é‡å¯æœåŠ¡..." -ForegroundColor Yellow
        ssh -i "$sshKeyPath" -o StrictHostKeyChecking=no -o UserKnownHostsFile=NUL "${user}@${server}" "cd '${deployPath}/backend' && npm install --production && pm2 restart all"
        
        Write-Host "`nâœ… éƒ¨ç½²å®Œæˆï¼" -ForegroundColor Green
        Write-Host "ğŸŒ è®¿é—®åœ°å€: http://${server}"
        
      } else {
        Write-Host "âŒ æœªæ£€æµ‹åˆ° SSH ç§é’¥ï¼Œä»…æ˜¾ç¤ºæ‰‹åŠ¨å‘½ä»¤" -ForegroundColor Red
        Write-Host "`nğŸ”§ æ‰‹åŠ¨éƒ¨ç½²å‘½ä»¤ï¼š" -ForegroundColor Cyan
        Write-Host "================================="
        Write-Host "# å¤‡ä»½"
        Write-Host "ssh -i ~/.ssh/id_rsa ${user}@${server} 'cd ${deployPath} && tar -czf backup_${timestamp}.tar.gz backend frontend'"
        Write-Host ""
        Write-Host "# ä¸Šä¼ åç«¯"
        Write-Host "scp -i ~/.ssh/id_rsa -r back/* ${user}@${server}:${deployPath}/backend/"
        Write-Host ""
        Write-Host "# ä¸Šä¼ å‰ç«¯"
        Write-Host "scp -i ~/.ssh/id_rsa -r front/* ${user}@${server}:${deployPath}/frontend/"
        Write-Host ""
        Write-Host "# å®‰è£…ä¾èµ–å¹¶é‡å¯"
        Write-Host "ssh -i ~/.ssh/id_rsa ${user}@${server} 'cd ${deployPath}/backend && npm install --production && pm2 restart all'"
        Write-Host "================================="
      }
  tags:
    - local
  only:
    - main
  when: manual


deploy-auto:
  stage: deploy
  before_script:
    - |
      Write-Host "ğŸš€ å…¨è‡ªåŠ¨éƒ¨ç½²åˆå§‹åŒ–..." -ForegroundColor Cyan

      # === æ£€æŸ¥å¿…è¦ç¯å¢ƒå˜é‡ ===
      $requiredVars = @("SERVER_IP", "SERVER_USER", "DEPLOY_PATH", "SSH_PRIVATE_KEY")
      $missingVars = @()
      foreach ($var in $requiredVars) {
        if ([string]::IsNullOrWhiteSpace((Get-Item "env:$var").Value)) {
          $missingVars += $var
        }
      }
      if ($missingVars.Count -gt 0) {
        Write-Host "âŒ ç¼ºå°‘ä»¥ä¸‹ GitLab CI/CD å˜é‡: $($missingVars -join ', ')" -ForegroundColor Red
        Write-Host "è¯·åœ¨é¡¹ç›® Settings â†’ CI/CD â†’ Variables ä¸­è®¾ç½®å®ƒä»¬" -ForegroundColor Yellow
        exit 1
      }

      # âœ… å…³é”®ä¿®å¤ï¼šä½¿ç”¨ç³»ç»Ÿ TEMP ç›®å½•ï¼ˆä¸å†ç”¨ C:\newtempï¼ï¼‰
      $sshKeyPath = "$env:TEMP\gitlab_deploy_key"
      Write-Host "é…ç½® SSH ç§é’¥åˆ°ä¸´æ—¶è·¯å¾„: $sshKeyPath" -ForegroundColor Yellow

      # === æ ‡å‡†åŒ–ç§é’¥æ ¼å¼ ===
      $rawKey = $env:SSH_PRIVATE_KEY
      $normalizedKey = $rawKey -replace "`r`n", "`n" -replace "`r", "`n"
      if (-not $normalizedKey.EndsWith("`n")) {
        $normalizedKey += "`n"
      }

      # å†™å…¥æ–‡ä»¶ï¼ˆç°åœ¨ä¸€å®šæœ‰æƒé™ï¼ï¼‰
      $bytes = [System.Text.Encoding]::UTF8.GetBytes($normalizedKey)
      [System.IO.File]::WriteAllBytes($sshKeyPath, $bytes)

      # === è°ƒè¯•è¾“å‡º ===
      $firstLine = Get-Content -Path $sshKeyPath -First 1 -Encoding UTF8
      Write-Host "DEBUG: ç§é’¥é¦–è¡Œ: $firstLine" -ForegroundColor Magenta

      # === è®¾ç½®ä¸¥æ ¼æƒé™ ===
      $currentUserName = [System.Security.Principal.WindowsIdentity]::GetCurrent().Name
      Write-Host "ğŸ”’ é™åˆ¶ç§é’¥æƒé™ï¼ˆä»… ${currentUserName} å¯è¯»ï¼‰..." -ForegroundColor Yellow
      icacls "$sshKeyPath" /inheritance:r /grant:r "${currentUserName}:(R)" /Q 2>$null | Out-Null
      Write-Host "âœ… ç§é’¥æƒé™å·²é”å®š" -ForegroundColor Green

      # === æµ‹è¯•æœåŠ¡å™¨è¿é€šæ€§ ===
      Write-Host "ğŸ“¡ æµ‹è¯•æœåŠ¡å™¨è¿é€šæ€§ ($($env:SERVER_IP))..." -ForegroundColor Yellow
      $pingSuccess = $false
      for ($i = 1; $i -le 3; $i++) {
        Write-Host "å°è¯• $i/3..."
        if (Test-Connection -ComputerName $env:SERVER_IP -Count 1 -Quiet -ErrorAction SilentlyContinue) {
          $pingSuccess = $true
          Write-Host "âœ… æœåŠ¡å™¨å¯è¾¾" -ForegroundColor Green
          break
        }
        Start-Sleep -Seconds 2
      }
      if (-not $pingSuccess) {
        Write-Host "âŒ æ— æ³• ping é€š $($env:SERVER_IP)" -ForegroundColor Red
        exit 1
      }

      # === æµ‹è¯• SSH è¿æ¥ ===
      Write-Host "ğŸ”‘ æµ‹è¯• SSH è¿æ¥..." -ForegroundColor Yellow
      $sshTestCmd = "ssh -i `"${sshKeyPath}`" -o ConnectTimeout=10 -o BatchMode=yes -o StrictHostKeyChecking=no `"${env:SERVER_USER}@${env:SERVER_IP}`" `"echo 'SSH_OK' && exit 0`""
      $result = & cmd /c "$sshTestCmd" 2>&1
      if ($LASTEXITCODE -eq 0 -and ($result -join "`n") -match "SSH_OK") {
        Write-Host "âœ… SSH è¿æ¥æˆåŠŸ" -ForegroundColor Green
        [System.Environment]::SetEnvironmentVariable("GITLAB_SSH_KEY_PATH", $sshKeyPath)
      } else {
        Write-Host "âŒ SSH è¿æ¥å¤±è´¥" -ForegroundColor Red
        Write-Host "è¾“å‡º: $($result -join "`n")" -ForegroundColor Gray
        exit 1
      }

  script:
    - |
      Write-Host "ğŸ¯ å¼€å§‹å…¨è‡ªåŠ¨éƒ¨ç½²..." -ForegroundColor Green
      Write-Host "================================="

      $server = $env:SERVER_IP
      $user = $env:SERVER_USER
      $deployPath = $env:DEPLOY_PATH
      $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
      $sshKeyPath = $env:GITLAB_SSH_KEY_PATH

      if (-not $sshKeyPath -or -not (Test-Path $sshKeyPath)) {
        Write-Host "âŒ SSH å¯†é’¥è·¯å¾„æ— æ•ˆ" -ForegroundColor Red
        exit 1
      }

      Write-Host "éƒ¨ç½²ä¿¡æ¯:" -ForegroundColor Cyan
      Write-Host "  - æœåŠ¡å™¨: ${user}@${server}"
      Write-Host "  - è·¯å¾„: ${deployPath}"
      Write-Host "  - æ—¶é—´æˆ³: ${timestamp}"
      Write-Host ""

      # å¤‡ä»½
      Write-Host "1ï¸âƒ£ å¤‡ä»½ç°æœ‰ä»£ç ..." -ForegroundColor Yellow
      $backupCmd = "cd '${deployPath}' && tar -czf backup_${timestamp}.tar.gz backend frontend 2>/dev/null || echo 'é¦–æ¬¡éƒ¨ç½²ï¼Œè·³è¿‡å¤‡ä»½'"
      & cmd /c "ssh -i `"${sshKeyPath}`" -o BatchMode=yes -o StrictHostKeyChecking=no `${user}@${server}` `$backupCmd`" | Out-Null
      Write-Host "âœ… å¤‡ä»½å®Œæˆ" -ForegroundColor Green

      # ä¸Šä¼ åç«¯
      if (Test-Path "back") {
        Write-Host "`n2ï¸âƒ£ ä¸Šä¼ åç«¯..." -ForegroundColor Yellow
        & cmd /c "ssh -i `"${sshKeyPath}`" `${user}@${server}` `"mkdir -p ${deployPath}/backend`"" | Out-Null
        & cmd /c "scp -i `"${sshKeyPath}`" -r -o BatchMode=yes back/* `${user}@${server}:${deployPath}/backend/`"
        Write-Host "âœ… åç«¯ä¸Šä¼ å®Œæˆ" -ForegroundColor Green
      }

      # ä¸Šä¼ å‰ç«¯
      if (Test-Path "front") {
        Write-Host "`n3ï¸âƒ£ ä¸Šä¼ å‰ç«¯..." -ForegroundColor Yellow
        & cmd /c "ssh -i `"${sshKeyPath}`" `${user}@${server}` `"mkdir -p ${deployPath}/frontend`"" | Out-Null
        & cmd /c "scp -i `"${sshKeyPath}`" -r -o BatchMode=yes front/* `${user}@${server}:${deployPath}/frontend/`"
        Write-Host "âœ… å‰ç«¯ä¸Šä¼ å®Œæˆ" -ForegroundColor Green
      }

      # é‡å¯æœåŠ¡
      Write-Host "`n4ï¸âƒ£ é‡å¯æœåŠ¡..." -ForegroundColor Yellow
      $restartScript = @"
      cd '${deployPath}/backend'
      npm install --production
      pm2 restart all || pm2 start npm --name 'backend' -- run start
      "@
      & cmd /c "ssh -i `"${sshKeyPath}`" -o BatchMode=yes -o StrictHostKeyChecking=no `${user}@${server}` `$restartScript`" | Out-Null
      Write-Host "âœ… æœåŠ¡å·²æ›´æ–°" -ForegroundColor Green

      Write-Host "`nğŸ‰ éƒ¨ç½²æˆåŠŸï¼è®¿é—®: http://${server}:3000" -ForegroundColor Green

  after_script:
    - |
      Write-Host "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..." -ForegroundColor Gray
      $sshKeyPath = "$env:TEMP\gitlab_deploy_key"
      if (Test-Path $sshKeyPath) {
        Remove-Item $sshKeyPath -Force
        Write-Host "âœ… å·²æ¸…ç† SSH ç§é’¥" -ForegroundColor Green
      }

  tags:
    - local
  only:
    - main
  when: on_success
  environment:
    name: production
    url: http://$SERVER_IP:3000